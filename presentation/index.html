<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Codescry â€” Static Analysis of Technology Stacks &amp; Code Structure</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/reveal.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/theme/black.css" id="theme">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/plugin/highlight/monokai.css">
  <style>
    .reveal .slides section {
      overflow-y: auto;
      max-height: 100%;
    }
    :root {
      --r-background-color: #0f172a;
      --r-main-color: #e2e8f0;
      --r-heading-color: #38bdf8;
      --r-link-color: #38bdf8;
      --r-link-color-hover: #7dd3fc;
      --r-selection-background-color: #1e40af;
      --r-heading-font: 'Inter', 'Segoe UI', system-ui, sans-serif;
      --r-main-font: 'Inter', 'Segoe UI', system-ui, sans-serif;
      --r-code-font: 'JetBrains Mono', 'Fira Code', monospace;
    }
    .reveal h1, .reveal h2, .reveal h3 {
      text-transform: none;
      font-weight: 700;
    }
    .reveal h1 { font-size: 1.8em; }
    .reveal h2 { font-size: 1.3em; }
    .reveal h3 { font-size: 1.0em; color: #94a3b8; }
    .reveal pre { font-size: 0.5em; box-shadow: none; }
    .reveal pre code {
      border-radius: 8px;
      padding: 12px !important;
      max-height: 420px;
    }
    .reveal p { font-size: 0.75em; }
    .reveal ul, .reveal ol { font-size: 0.75em; }
    .reveal li { margin-bottom: 0.3em; }
    .reveal .small { font-size: 0.6em; color: #94a3b8; }
    .reveal .accent { color: #38bdf8; }
    .reveal .accent-green { color: #4ade80; }
    .reveal .accent-amber { color: #fbbf24; }
    .reveal .accent-pink { color: #f472b6; }
    .reveal .accent-purple { color: #a78bfa; }
    .reveal .dim { color: #64748b; }
    .reveal .pill {
      display: inline-block;
      padding: 2px 12px;
      border-radius: 999px;
      font-size: 0.65em;
      font-weight: 600;
      margin: 2px;
    }
    .pill-blue { background: #1e3a5f; color: #7dd3fc; }
    .pill-green { background: #14532d; color: #86efac; }
    .pill-amber { background: #451a03; color: #fde68a; }
    .pill-pink { background: #500724; color: #fbcfe8; }
    .pill-purple { background: #2e1065; color: #c4b5fd; }
    .reveal table { font-size: 0.6em; margin: 0 auto; }
    .reveal table th { background: #1e293b; color: #38bdf8; font-weight: 600; }
    .reveal table td { border-color: #334155; }
    .reveal .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      text-align: left;
    }
    .reveal .three-col {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 20px;
      text-align: left;
    }
    .reveal .card {
      background: #1e293b;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #334155;
    }
    .reveal .card h3 { margin-top: 0; font-size: 0.85em; }
    .reveal .card p, .reveal .card ul { font-size: 0.65em; }
    .pipeline-box {
      background: #1e293b;
      border: 2px solid #334155;
      border-radius: 10px;
      padding: 12px 20px;
      margin: 8px 0;
      text-align: center;
      font-size: 0.7em;
      position: relative;
    }
    .pipeline-box.active {
      border-color: #38bdf8;
      box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
    }
    .pipeline-arrow {
      text-align: center;
      font-size: 1.4em;
      color: #475569;
      margin: 2px 0;
    }
    .reveal .fragment.semi-fade-out.visible {
      opacity: 0.3 !important;
    }
    .reveal section img {
      border: none;
      box-shadow: none;
      background: none;
    }
    .lang-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      font-size: 0.6em;
    }
    .lang-grid .lang-item {
      background: #1e293b;
      border-radius: 6px;
      padding: 8px;
      text-align: center;
      border: 1px solid #334155;
    }
    .section-divider {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;
    }
    .reveal .title-slide h1 {
      font-size: 2.4em;
      background: linear-gradient(135deg, #38bdf8, #818cf8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  </style>
</head>
<body>
<div class="reveal">
<div class="slides">

<!-- ============================================================ -->
<!-- TITLE -->
<!-- ============================================================ -->
<section class="title-slide" data-background-gradient="linear-gradient(135deg, #0f172a, #1e1b4b)">
  <h1>Codescry</h1>
  <h3>Static Analysis of Technology Stacks<br>&amp; Code Structure</h3>
  <p class="small" style="margin-top: 40px;">16 languages &middot; 13 integration types &middot; 90+ frameworks</p>
</section>

<!-- ============================================================ -->
<!-- THE PROBLEM -->
<!-- ============================================================ -->
<section>
  <h2>The Problem</h2>
  <div class="two-col">
    <div>
      <p>You inherit a large codebase. You need to answer:</p>
      <ul>
        <li>What languages and frameworks are in here?</li>
        <li>Where are the <span class="accent">system boundaries</span>?</li>
        <li>Which code symbols own which integration points?</li>
        <li>What does the control flow look like?</li>
      </ul>
    </div>
    <div class="card">
      <h3 class="accent-amber">Why not just grep?</h3>
      <ul>
        <li>Matches in <span class="accent-pink">comments and strings</span></li>
        <li>No framework awareness &mdash; <code>Map.get()</code> isn't a Javalin route</li>
        <li>No symbol-level attribution</li>
        <li>No direction: <em>is this an API we expose or consume?</em></li>
      </ul>
    </div>
  </div>
</section>

<!-- ============================================================ -->
<!-- WHAT CODESCRY DOES - ONE SLIDE -->
<!-- ============================================================ -->
<section>
  <h2>What Codescry Does</h2>
  <p>A Python library that <strong>statically scans</strong> a repository and produces a structured understanding of its technology landscape &mdash; <em>without running any code</em>.</p>
  <div class="three-col" style="margin-top: 30px;">
    <div class="card">
      <h3 class="accent">Detect</h3>
      <p>Languages, frameworks, package managers, infrastructure, and <strong>13 types</strong> of system integration points</p>
    </div>
    <div class="card">
      <h3 class="accent-green">Resolve</h3>
      <p>Map every integration signal to its <strong>owning code symbol</strong> (class, method, function)</p>
    </div>
    <div class="card">
      <h3 class="accent-amber">Classify</h3>
      <p>Determine signal direction: <strong>inward</strong> (we expose), <strong>outward</strong> (we consume), or ambiguous</p>
    </div>
  </div>
</section>

<!-- ============================================================ -->
<!-- SECTION: LANGUAGE COVERAGE -->
<!-- ============================================================ -->
<section>
  <h2>Language Coverage</h2>
  <div class="lang-grid">
    <div class="lang-item"><strong>Java</strong><br><span class="small">15 frameworks</span></div>
    <div class="lang-item"><strong>Python</strong><br><span class="small">9 frameworks</span></div>
    <div class="lang-item"><strong>TypeScript</strong><br><span class="small">shared w/ JS</span></div>
    <div class="lang-item"><strong>JavaScript</strong><br><span class="small">13 frameworks</span></div>
    <div class="lang-item"><strong>Go</strong><br><span class="small">6 frameworks</span></div>
    <div class="lang-item"><strong>Rust</strong><br><span class="small">4 frameworks</span></div>
    <div class="lang-item"><strong>C#</strong><br><span class="small">7 frameworks</span></div>
    <div class="lang-item"><strong>C / C++</strong><br><span class="small">5 frameworks</span></div>
    <div class="lang-item"><strong>Kotlin</strong><br><span class="small">shared + 2</span></div>
    <div class="lang-item"><strong>Scala</strong><br><span class="small">11 frameworks</span></div>
    <div class="lang-item"><strong>PHP</strong><br><span class="small">7 frameworks</span></div>
    <div class="lang-item"><strong>Ruby</strong><br><span class="small">3 frameworks</span></div>
    <div class="lang-item"><strong>COBOL</strong><br><span class="small">6 core types</span></div>
    <div class="lang-item"><strong>PL/I</strong><br><span class="small">6 core types</span></div>
    <div class="lang-item"><strong>Pascal</strong><br><span class="small">9 base types</span></div>
    <div class="lang-item" style="border-color: #334155; opacity: 0.5;"><strong>+more</strong><br><span class="small">plugin system</span></div>
  </div>
  <p class="small" style="margin-top: 20px;">All 13 integration types covered for modern languages. Pascal covers 9 base types. COBOL/PL/I cover 6 mainframe-relevant types.</p>
</section>

<!-- ============================================================ -->
<!-- SECTION: THE PIPELINE -->
<!-- ============================================================ -->
<section class="section-divider">
  <h2>The Pipeline</h2>
  <h3>Six stages, one function call</h3>
</section>

<!-- PIPELINE OVERVIEW -->
<section>
  <h2>Pipeline at a Glance</h2>
  <pre><code class="language-python">from repo_surveyor import survey

report, symbols, signals, resolved, concretised = survey(
    "/path/to/repo",
    languages=["Java", "Python"],
)</code></pre>
  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr; gap: 6px; margin-top: 25px; font-size: 0.5em;">
    <div class="pipeline-box active">
      <strong class="accent">1. Tech Stacks</strong><br>
      <span class="dim">Indicator files,<br>glob patterns,<br>dependency parsing</span>
    </div>
    <div class="pipeline-box active">
      <strong class="accent">2. Coarse Structure</strong><br>
      <span class="dim">Universal CTags<br>symbol extraction</span>
    </div>
    <div class="pipeline-box active">
      <strong class="accent">3. Integration Detection</strong><br>
      <span class="dim">tree-sitter zones +<br>regex patterns</span>
    </div>
    <div class="pipeline-box active">
      <strong class="accent-green">4. Signal Dedup</strong><br>
      <span class="dim">Merge duplicates<br>into composites<br>via SignalLike</span>
    </div>
    <div class="pipeline-box active">
      <strong class="accent">5. Symbol Resolution</strong><br>
      <span class="dim">Spatial join:<br>signal &rarr; symbol</span>
    </div>
    <div class="pipeline-box active">
      <strong class="accent">6. Concretisation</strong><br>
      <span class="dim">ML classifier:<br>direction labelling</span>
    </div>
  </div>
</section>

<!-- PIPELINE FLOW DIAGRAM -->
<section>
  <h2>Pipeline Flow</h2>
  <div style="display: grid; grid-template-columns: auto 1fr; gap: 0 18px; align-items: center; max-width: 820px; margin: 0 auto; font-size: 0.62em;">
    <!-- Stage 1 -->
    <div class="pipeline-box" style="width: 260px; border-color: #38bdf8;">
      <strong class="accent">1. Tech Stacks</strong>
    </div>
    <div><span class="dim">Indicator files, globs, dependency parsing</span> &rarr; <code>SurveyReport</code></div>

    <div class="pipeline-arrow">&darr;</div><div></div>

    <!-- Stage 2 -->
    <div class="pipeline-box" style="width: 260px; border-color: #38bdf8;">
      <strong class="accent">2. Coarse Structure</strong>
    </div>
    <div><span class="dim">Universal CTags symbol extraction</span> &rarr; <code>CTagsResult</code></div>

    <div class="pipeline-arrow">&darr;</div><div></div>

    <!-- Stage 3 -->
    <div class="pipeline-box" style="width: 260px; border-color: #38bdf8;">
      <strong class="accent">3. Integration Detection</strong>
    </div>
    <div><span class="dim">tree-sitter zones + regex patterns</span> &rarr; <code>IntegrationDetectorResult</code></div>

    <div class="pipeline-arrow">&darr;</div><div></div>

    <!-- Stage 4 -->
    <div class="pipeline-box" style="width: 260px; border-color: #4ade80;">
      <strong class="accent-green">4. Signal Deduplication</strong>
    </div>
    <div><span class="dim">Merge (file, line, content) duplicates</span> &rarr; <code>CompositeIntegrationSignal</code></div>

    <div class="pipeline-arrow">&darr;</div><div></div>

    <!-- Stage 5 -->
    <div class="pipeline-box" style="width: 260px; border-color: #a78bfa;">
      <strong class="accent-purple">5. Symbol Resolution</strong>
    </div>
    <div><span class="dim">Spatial join: signal &rarr; owning symbol</span> &rarr; <code>ResolutionResult</code></div>

    <div class="pipeline-arrow">&darr;</div><div></div>

    <!-- Stage 6 -->
    <div class="pipeline-box" style="width: 260px; border-color: #fbbf24;">
      <strong class="accent-amber">6. Concretisation</strong>
    </div>
    <div>
      <span class="dim">Two-stage:</span>
      <span class="pill pill-green" style="font-size: 0.85em;">SIGNAL</span> / <span class="pill pill-blue" style="font-size: 0.85em;">NOISE</span>
      then
      <span class="pill pill-green" style="font-size: 0.85em;">INWARD</span> / <span class="pill pill-amber" style="font-size: 0.85em;">OUTWARD</span> / <span class="pill pill-blue" style="font-size: 0.85em;">AMBIGUOUS</span>
    </div>
  </div>
  <p class="small" style="margin-top: 14px;">Stages 1&ndash;2 feed context into 3&ndash;6. Stage 4 reduces duplicates before the expensive downstream stages.</p>
</section>

<!-- ============================================================ -->
<!-- STAGE 1: TECH STACKS -->
<!-- ============================================================ -->
<section>
  <h2>Stage 1: Tech Stack Detection</h2>
  <div class="two-col">
    <div>
      <p>Walk the repo looking for <strong>indicator files</strong>:</p>
      <ul>
        <li><code>pom.xml</code> &rarr; Java + Maven</li>
        <li><code>pyproject.toml</code> &rarr; Python + Poetry</li>
        <li><code>Cargo.toml</code> &rarr; Rust + Cargo</li>
        <li><code>*.csproj</code> &rarr; C# + NuGet</li>
      </ul>
      <p style="margin-top: 15px;">Then <strong>parse</strong> those files to extract framework dependencies (not naive substring matching).</p>
    </div>
    <div class="card">
      <h3 class="accent">Per-directory association</h3>
      <p>Each marker is scoped to its directory &mdash; critical for <strong>monorepos</strong> where <code>backend/</code> is Java/Spring and <code>frontend/</code> is TypeScript/React.</p>
      <p class="dim" style="margin-top: 15px;">Also detects: Docker, Terraform, Kubernetes (via YAML <code>apiVersion:</code> markers)</p>
    </div>
  </div>
</section>

<!-- ============================================================ -->
<!-- STAGE 2: COARSE STRUCTURE -->
<!-- ============================================================ -->
<section>
  <h2>Stage 2: Coarse Structure (CTags)</h2>
  <div class="two-col">
    <div>
      <p>Shell out to <strong>Universal CTags</strong> with JSON output:</p>
      <pre><code class="language-bash">ctags --output-format=json \
     --fields=*  --extras=+q -R .</code></pre>
      <p style="margin-top: 15px;">Produces a list of <code>CTagsEntry</code> objects:</p>
      <ul>
        <li>Symbol name, kind (class, method, function)</li>
        <li>File path, start line, end line</li>
        <li>Scope (parent class/namespace)</li>
      </ul>
    </div>
    <div class="card">
      <h3 class="accent-green">Why CTags?</h3>
      <p>Fast, battle-tested, supports 100+ languages, and gives us <strong>line ranges</strong> for every symbol.</p>
      <p style="margin-top: 10px;">These line ranges become the <strong>spatial index</strong> used in Stage 4 to resolve signals to symbols.</p>
    </div>
  </div>
</section>

<!-- ============================================================ -->
<!-- STAGE 3: INTEGRATION DETECTION - OVERVIEW -->
<!-- ============================================================ -->
<section>
  <h2>Stage 3: Integration Detection</h2>
  <h3>The core of Codescry</h3>
  <p style="margin-top: 20px;">Two sub-stages for each source file:</p>
  <div style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 10px; margin-top: 20px;">
    <div class="pipeline-box">
      <strong class="accent-amber">A. Import Gating</strong><br>
      <span class="dim">Filter framework patterns by actual imports in the file</span>
    </div>
    <div style="font-size: 1.4em; color: #475569;">&rarr;</div>
    <div class="pipeline-box">
      <strong class="accent">B. Zone-Filtered Pattern Matching</strong><br>
      <span class="dim">tree-sitter classifies lines &rarr; skip comments/strings &rarr; apply regex</span>
    </div>
  </div>
</section>

<!-- TREE-SITTER SYNTAX ZONES -->
<section>
  <h2>Syntax Zone Filtering</h2>
  <h3>How tree-sitter prevents false positives</h3>
  <div class="two-col">
    <div>
      <p>Before applying any regex, each line is classified into a <strong>syntax zone</strong>:</p>
      <table>
        <tr><th>Zone</th><th>Action</th></tr>
        <tr><td><code>CODE</code></td><td class="accent-green">Scan</td></tr>
        <tr><td><code>COMMENT</code></td><td class="accent-pink">Skip</td></tr>
        <tr><td><code>STRING_LITERAL</code></td><td class="accent-pink">Skip</td></tr>
        <tr><td><code>IMPORT</code></td><td class="accent-pink">Skip</td></tr>
        <tr><td><code>PACKAGE_DECLARATION</code></td><td class="accent-pink">Skip</td></tr>
      </table>
    </div>
    <div>
      <pre><code class="language-python"># tree-sitter AST walk to build zone map
def build_syntax_range_map(root_node, source_lines):
    ranges = []
    stack = [root_node]
    while stack:
        node = stack.pop()
        zone = _classify_node(node.type)
        if zone is not None:
            effective = _effective_range(
                node, zone, source_lines
            )
            if effective is not None:
                ranges.append(effective)
            continue  # don't recurse into matches
        stack.extend(reversed(node.children))
    ranges.sort(key=lambda r: r.start_row)
    return SyntaxRangeMap(ranges=tuple(ranges))</code></pre>
    </div>
  </div>
</section>

<!-- THREE-LAYER PATTERN MERGING -->
<section>
  <h2>Three-Layer Pattern Merging</h2>
  <div style="display: grid; grid-template-columns: 1fr auto 1fr auto 1fr; align-items: center; gap: 10px;">
    <div class="pipeline-box" style="border-color: #475569;">
      <strong class="dim">Layer 1: Common</strong><br>
      <span class="small">Cross-language, low confidence</span><br>
      <span class="small"><code>(?i)\bkafka\b</code>, <code>(?i)\bredis\b</code></span>
    </div>
    <div style="font-size: 1.4em; color: #475569;">&rarr;</div>
    <div class="pipeline-box" style="border-color: #38bdf8;">
      <strong class="accent">Layer 2: Language Base</strong><br>
      <span class="small">Always active for that language</span><br>
      <span class="small"><code>@WebService</code>, <code>import grpc</code></span>
    </div>
    <div style="font-size: 1.4em; color: #475569;">&rarr;</div>
    <div class="pipeline-box" style="border-color: #4ade80;">
      <strong class="accent-green">Layer 3: Framework</strong><br>
      <span class="small">Import-gated</span><br>
      <span class="small"><code>@RestController</code>, <code>@app.get</code></span>
    </div>
  </div>
  <p class="small" style="margin-top: 15px;">Double gating: framework must be in the directory's tech stack <strong>AND</strong> imported in the file</p>
</section>

<!-- PATTERN EXAMPLE: SPRING -->
<section>
  <h2>Pattern Anatomy: Spring</h2>
  <pre><code class="language-python">FRAMEWORK = FrameworkPatternSpec(
    name="Spring",
    patterns={
        IntegrationType.HTTP_REST: {
            PatternKey.PATTERNS: [
                (r"@RestController", Confidence.HIGH, SignalDirection.INWARD),
                (r"@GetMapping",     Confidence.HIGH, SignalDirection.INWARD),
                (r"@PostMapping",    Confidence.HIGH, SignalDirection.INWARD),
            ],
        },
        IntegrationType.MESSAGING: {
            PatternKey.PATTERNS: [
                (r"@KafkaListener",  Confidence.HIGH, SignalDirection.INWARD),
                (r"KafkaTemplate",   Confidence.HIGH, SignalDirection.OUTWARD),
            ],
        },
        IntegrationType.DATABASE: {
            PatternKey.PATTERNS: [
                (r"@Repository",     Confidence.HIGH, SignalDirection.OUTWARD),
                (r"JdbcTemplate",    Confidence.HIGH, SignalDirection.OUTWARD),
                (r"Neo4jRepository", Confidence.HIGH, SignalDirection.OUTWARD),
            ],
        },
    },
)</code></pre>
  <p class="small">Each pattern carries: <span class="pill pill-blue">regex</span> <span class="pill pill-green">confidence</span> <span class="pill pill-amber">direction</span></p>
</section>

<!-- INTEGRATION SIGNAL -->
<section>
  <h2>The IntegrationSignal</h2>
  <pre><code class="language-python">@dataclass(frozen=True)
class IntegrationSignal:
    match: FileMatch           # file, line number, line content, language
    integration_type: IntegrationType  # one of 13 types
    confidence: Confidence     # HIGH / MEDIUM / LOW
    matched_pattern: str       # the regex that fired
    entity_type: EntityType    # FILE_CONTENT
    source: str                # "common", "Java", or "Spring"
    direction: SignalDirection  # INWARD / OUTWARD / AMBIGUOUS</code></pre>
  <div class="three-col" style="margin-top: 20px;">
    <div class="card">
      <h3 class="accent">13 Integration Types</h3>
      <p>HTTP/REST, SOAP, messaging, database, gRPC, GraphQL, sockets, file I/O, email, caching, SSE, FTP/SFTP, scheduling</p>
    </div>
    <div class="card">
      <h3 class="accent-green">3 Confidence Levels</h3>
      <p><strong>HIGH</strong>: framework annotation<br><strong>MEDIUM</strong>: language-level pattern<br><strong>LOW</strong>: generic keyword</p>
    </div>
    <div class="card">
      <h3 class="accent-amber">3 Directions</h3>
      <p><strong>INWARD</strong>: we expose it<br><strong>OUTWARD</strong>: we consume it<br><strong>AMBIGUOUS</strong>: can't tell from pattern alone</p>
    </div>
  </div>
</section>

<!-- INTEGRATION SIGNAL DIAGRAM -->
<section>
  <h2>Integration Signal Diagram</h2>
  <p class="small">Codescry run against its own codebase</p>
  <img src="../docs/images/integration_signals.svg" alt="Integration Signals" style="max-height: 450px; background: white; border-radius: 8px; padding: 10px;">
  <p class="small" style="margin-top: 10px;">Symbols grouped by file (dashed clusters), integration types as teal nodes. Edge weight = confidence.</p>
</section>

<!-- ============================================================ -->
<!-- STAGE 4: SIGNAL DEDUPLICATION -->
<!-- ============================================================ -->
<section>
  <h2>Stage 4: Signal Deduplication</h2>
  <h3>Merging duplicates before downstream processing</h3>
  <div class="two-col">
    <div>
      <p>A single source line can match <strong>multiple patterns</strong> (e.g. both <code>http_rest</code> and <code>database</code>). Before symbol resolution or concretisation, duplicates are merged:</p>
      <pre><code class="language-python">def _deduplicate_detector_result(result):
    file_content = [s for s in result.integration_points
                    if s.entity_type == EntityType.FILE_CONTENT]
    non_file_content = [s for s in result.integration_points
                        if s.entity_type != EntityType.FILE_CONTENT]
    composites = deduplicate_signals(file_content)
    return IntegrationDetectorResult(
        integration_points=non_file_content + composites,
        files_scanned=result.files_scanned,
    )</code></pre>
    </div>
    <div class="card">
      <h3 class="accent-green">SignalLike Protocol</h3>
      <p>Both <code>IntegrationSignal</code> and <code>CompositeIntegrationSignal</code> satisfy the <code>SignalLike</code> protocol, so all downstream consumers work uniformly:</p>
      <ul>
        <li>Symbol resolution</li>
        <li>AST grouper</li>
        <li>ML concretiser</li>
        <li>Ollama / Gemini / Embedding concretisers</li>
      </ul>
      <p style="margin-top: 10px;">Each composite preserves <strong>all original match metadata</strong> while eliminating redundant processing.</p>
    </div>
  </div>
</section>

<!-- ============================================================ -->
<!-- STAGE 5: SYMBOL RESOLUTION -->
<!-- ============================================================ -->
<section>
  <h2>Stage 5: Symbol Resolution</h2>
  <h3>Spatial join: signal &rarr; symbol</h3>
  <div class="two-col">
    <div>
      <p>Each signal has a <strong>file + line number</strong>.<br>
         Each symbol has a <strong>file + line range</strong>.</p>
      <p style="margin-top: 15px;">Resolution = find the <strong>narrowest containing symbol</strong> for each signal.</p>
      <pre><code class="language-python">@dataclass(frozen=True)
class SymbolIntegrationProfile:
    symbol_name: str
    symbol_kind: str   # class, method, function
    symbol_path: str
    integrations: tuple[SymbolIntegration, ...]</code></pre>
    </div>
    <div class="card">
      <h3 class="accent-purple">What this gives you</h3>
      <p>Not just "there's a Kafka call on line 47" but:</p>
      <p style="font-style: italic; color: #7dd3fc; margin-top: 10px;">
        "<code>OrderService.processOrder()</code> has 3 integration points: Kafka outbound, REST inbound, and database outbound"
      </p>
      <p style="margin-top: 15px;">This is the <strong>per-symbol integration profile</strong>.</p>
    </div>
  </div>
</section>

<!-- ============================================================ -->
<!-- STAGE 5: CONCRETISATION -->
<!-- ============================================================ -->
<section>
  <h2>Stage 6: Signal Concretisation</h2>
  <h3>Resolving ambiguity with ML</h3>
  <div class="two-col">
    <div>
      <p>Some patterns can't determine direction from regex alone. The concretiser classifies each signal in two stages:</p>
      <ul>
        <li><strong>Validity:</strong> <span class="accent-green">SIGNAL</span> or <span class="dim">NOISE</span></li>
        <li><strong>Direction:</strong> <span class="accent-green">INWARD</span> / <span class="accent-amber">OUTWARD</span> / <span class="dim">AMBIGUOUS</span></li>
      </ul>
      <p style="margin-top: 15px;">Classifier: <strong>TF-IDF</strong> (word + char n-grams) + <strong>Logistic Regression</strong></p>
      <p class="small">No API calls at inference. Serialised with joblib.</p>
    </div>
    <div class="card">
      <h3 class="accent">Training Pipeline</h3>
      <ol style="font-size: 0.75em;">
        <li>Generate synthetic examples via <strong>Claude</strong> for each (language, type, label) triple</li>
        <li>Harvest real code from <strong>GitHub code search</strong> using patterns as queries</li>
        <li>Validate against the pattern registry</li>
        <li>Export stratified train/val/test JSONL splits</li>
        <li>Train TF-IDF + LR classifier</li>
      </ol>
    </div>
  </div>
</section>

<!-- ============================================================ -->
<!-- SECTION: PLUGIN ARCHITECTURE -->
<!-- ============================================================ -->
<section>
  <h2>Plugin Architecture</h2>
  <h3>Adding a new language</h3>
  <div class="two-col">
    <div>
      <p><code>languages.json</code> is the single source of truth:</p>
      <pre><code class="language-json">{
  "Ruby": {
    "extensions": [".rb"],
    "indicator_files": {
      "Gemfile": {
        "package_managers": ["Bundler"],
        "parser": "gemfile"
      }
    },
    "framework_patterns": {
      "rails": "Rails",
      "sinatra": "Sinatra"
    },
    "integration_module": "ruby"
  }
}</code></pre>
    </div>
    <div>
      <p>Framework patterns auto-discovered via <code>pkgutil</code>:</p>
      <pre style="font-size: 0.5em;"><code class="nohighlight">integration_patterns/
  ruby/
    __init__.py          # auto-discovers siblings
    base.py              # BASE: BasePatternSpec
    rails.py             # FRAMEWORK: FrameworkPatternSpec
    sinatra.py           # FRAMEWORK: FrameworkPatternSpec
    cfg_roles.json       # CFG node-type mappings</code></pre>
      <p style="margin-top: 15px;">Drop in a new <code>.py</code> file exporting <code>FRAMEWORK</code> and it's automatically picked up.</p>
    </div>
  </div>
</section>

<!-- ============================================================ -->
<!-- SECTION: CFG CONSTRUCTION -->
<!-- ============================================================ -->
<section class="section-divider">
  <h2>CFG Construction</h2>
  <h3>Language-independent control flow graphs</h3>
</section>

<!-- CFG ROLE SCHEMA -->
<section>
  <h2>The Role Schema</h2>
  <p>Instead of writing a CFG builder per language, map <strong>tree-sitter node types</strong> to <strong>12 universal roles</strong>:</p>
  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 20px; font-size: 0.65em;">
    <div class="card" style="padding: 12px;">
      <span class="accent">SEQUENCE</span><br>
      <span class="dim">block, program</span>
    </div>
    <div class="card" style="padding: 12px;">
      <span class="accent-amber">BRANCH</span><br>
      <span class="dim">if, ternary</span>
    </div>
    <div class="card" style="padding: 12px;">
      <span class="accent-amber">SWITCH</span><br>
      <span class="dim">switch, match</span>
    </div>
    <div class="card" style="padding: 12px;">
      <span class="accent-green">LOOP</span><br>
      <span class="dim">while, for</span>
    </div>
    <div class="card" style="padding: 12px;">
      <span class="accent-green">LOOP_POST</span><br>
      <span class="dim">do...while</span>
    </div>
    <div class="card" style="padding: 12px;">
      <span class="accent-pink">RETURN</span><br>
      <span class="dim">return, yield</span>
    </div>
    <div class="card" style="padding: 12px;">
      <span class="accent-pink">BREAK</span><br>
      <span class="dim">break</span>
    </div>
    <div class="card" style="padding: 12px;">
      <span class="accent-pink">CONTINUE</span><br>
      <span class="dim">continue</span>
    </div>
    <div class="card" style="padding: 12px;">
      <span class="accent-pink">THROW</span><br>
      <span class="dim">throw, raise</span>
    </div>
    <div class="card" style="padding: 12px;">
      <span class="accent-purple">TRY</span><br>
      <span class="dim">try/catch/finally</span>
    </div>
    <div class="card" style="padding: 12px;">
      <span class="dim">CALL</span><br>
      <span class="dim">function call</span>
    </div>
    <div class="card" style="padding: 12px;">
      <span class="dim">LEAF</span><br>
      <span class="dim">default / atomic</span>
    </div>
  </div>
</section>

<!-- CFG ROLES JSON -->
<section>
  <h2>Per-Language Config: <code>cfg_roles.json</code></h2>
  <div class="two-col">
    <div>
      <pre><code class="language-json">{
  "_meta": {"switch_fallthrough": true},
  "block": "sequence",
  "if_statement": {
    "role": "branch",
    "condition": "condition",
    "consequence": "consequence",
    "alternative": "alternative"
  },
  "for_statement": {
    "role": "loop",
    "condition": "condition",
    "body": "body",
    "initializer": "init",
    "update": "update"
  },
  "return_statement": "return",
  "break_statement": "break"
}</code></pre>
    </div>
    <div>
      <p><strong>Simple form:</strong> <code>"break_statement": "break"</code></p>
      <p style="margin-top: 15px;"><strong>Extended form:</strong> maps <em>semantic slots</em> to tree-sitter child field names:</p>
      <table>
        <tr><th>Slot</th><th>Purpose</th></tr>
        <tr><td><code>condition</code></td><td>Branch/loop test</td></tr>
        <tr><td><code>consequence</code></td><td>True branch</td></tr>
        <tr><td><code>alternative</code></td><td>Else branch</td></tr>
        <tr><td><code>body</code></td><td>Loop/switch body</td></tr>
        <tr><td><code>handler</code></td><td>Catch block</td></tr>
        <tr><td><code>finalizer</code></td><td>Finally block</td></tr>
      </table>
      <p class="small" style="margin-top: 15px;">Same algorithm, different JSON &rarr; different language</p>
    </div>
  </div>
</section>

<!-- CFG BUILDER ALGORITHM -->
<section>
  <h2>The Builder: Fragments</h2>
  <div class="two-col">
    <div>
      <p>Core abstraction: <strong>Fragment</strong> &mdash; a mini-CFG produced by each subtree.</p>
      <pre><code class="language-python">@dataclass(frozen=True)
class Fragment:
    entry: int           # entry node ID
    exits: frozenset     # normal exit IDs
    pending_breaks: tuple
    pending_continues: tuple
    pending_throws: tuple
    pending_returns: tuple</code></pre>
      <p style="margin-top: 10px;">Pending edges <strong>bubble up</strong> until an enclosing scope resolves them.</p>
    </div>
    <div>
      <p><strong>Algorithm:</strong></p>
      <ol>
        <li>Parse source with tree-sitter</li>
        <li>Recurse: <code>_build_fragment(node)</code></li>
        <li>Dispatch on the node's <strong>role</strong></li>
        <li>Each handler builds a Fragment</li>
        <li><code>chain()</code> connects fragments sequentially</li>
        <li>Pending breaks/continues resolved by enclosing loop</li>
        <li>Top-level: wire ENTRY &rarr; fragment &rarr; EXIT</li>
      </ol>
      <p class="small" style="margin-top: 15px;">Unmapped node types = transparent containers (recurse into children)</p>
    </div>
  </div>
</section>

<!-- CFG VISUALIZATION -->
<section>
  <h2>CFG Visualisation</h2>
  <div class="two-col">
    <div>
      <img src="../docs/images/cfg_example.svg" alt="CFG Example" style="max-height: 480px; background: white; border-radius: 8px; padding: 10px;">
    </div>
    <div>
      <p>Exported as <strong>Graphviz DOT</strong>, rendered to SVG.</p>
      <table style="margin-top: 15px;">
        <tr><th>Shape</th><th>Role</th></tr>
        <tr><td style="color: #fbbf24;">Diamond</td><td>Branch / Switch</td></tr>
        <tr><td style="color: #2dd4bf;">Hexagon</td><td>Loop</td></tr>
        <tr><td style="color: #f472b6;">Trapezium</td><td>Try</td></tr>
        <tr><td>Box</td><td>Leaf / Call / Return</td></tr>
      </table>
      <table style="margin-top: 15px;">
        <tr><th>Edge</th><th>Meaning</th></tr>
        <tr><td style="color: #4ade80;">Green (T)</td><td>True branch</td></tr>
        <tr><td style="color: #ef4444;">Red (F)</td><td>False branch</td></tr>
        <tr><td style="color: #a78bfa;">Purple dashed</td><td>Back edge (loop)</td></tr>
        <tr><td style="color: #ef4444;">Red dotted</td><td>Exception</td></tr>
      </table>
    </div>
  </div>
</section>

<!-- ============================================================ -->
<!-- SECTION: PIPELINE EXPERIMENTS -->
<!-- ============================================================ -->
<section class="section-divider">
  <h2>Concretisation Experiments</h2>
  <h3>Six approaches to the same classification problem</h3>
</section>

<!-- EXPERIMENT LANDSCAPE -->
<section>
  <h2>The Experiment Landscape</h2>
  <p>All six pipelines share stages 1&ndash;5. They differ only in <strong>Stage 6: Concretisation</strong> &mdash; how to classify each signal's validity and direction.</p>
  <!-- 2x3 positioning diagram -->
  <div style="display: grid; grid-template-columns: auto 1fr 1fr 1fr; gap: 0; margin-top: 18px; font-size: 0.55em; text-align: center;">
    <!-- header row -->
    <div></div>
    <div style="padding: 6px; color: #94a3b8; font-weight: 600;">Embedding-Based</div>
    <div style="padding: 6px; color: #94a3b8; font-weight: 600;">LLM-Based</div>
    <div style="padding: 6px; color: #94a3b8; font-weight: 600;">Hybrid</div>
    <!-- row: local -->
    <div style="padding: 10px 12px; color: #94a3b8; font-weight: 600; text-align: right;">Local</div>
    <div class="card" style="margin: 4px; padding: 10px;">
      <span class="accent-amber">ML Classifier</span><br>
      <span class="dim">TF-IDF + LR<br>No API calls</span>
    </div>
    <div class="card" style="margin: 4px; padding: 10px;">
      <span class="accent-purple">Ollama</span><br>
      <span class="dim">Local LLM<br>Qwen 7B</span>
    </div>
    <div style="margin: 4px; padding: 10px; opacity: 0.2;"></div>
    <!-- row: cloud -->
    <div style="padding: 10px 12px; color: #94a3b8; font-weight: 600; text-align: right;">Cloud</div>
    <div class="card" style="margin: 4px; padding: 10px;">
      <span class="accent">Generic Embedding</span><br>
      <span class="dim">26 descriptions<br>Cosine similarity</span>
    </div>
    <div class="card" style="margin: 4px; padding: 10px;">
      <span class="accent-green">Gemini Flash</span><br>
      <span class="dim">Cloud LLM<br>Multi-file batching</span>
    </div>
    <div class="card" style="margin: 4px; padding: 10px; border-color: #fbbf24;">
      <span class="accent-amber">Hybrid</span><br>
      <span class="dim">Embedding gate +<br>Gemini direction</span>
    </div>
    <!-- row: cloud cached -->
    <div style="padding: 10px 12px; color: #94a3b8; font-weight: 600; text-align: right;">Cached</div>
    <div class="card" style="margin: 4px; padding: 10px;">
      <span class="accent-pink">Pattern Embedding</span><br>
      <span class="dim">~3,430 descriptions<br>SHA-256 cache</span>
    </div>
    <div style="margin: 4px;"></div>
    <div style="margin: 4px;"></div>
  </div>
</section>

<!-- SHARED PIPELINE DIAGRAM -->
<section>
  <h2>Shared Pre-Concretisation Pipeline</h2>
  <p>Every experiment runs the same first five stages, then diverges:</p>
  <div style="display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 20px; font-size: 0.52em; flex-wrap: nowrap;">
    <div class="pipeline-box" style="border-color: #334155; min-width: 100px;">
      <strong class="dim">1. Tech Stacks</strong>
    </div>
    <div style="color: #475569;">&rarr;</div>
    <div class="pipeline-box" style="border-color: #334155; min-width: 100px;">
      <strong class="dim">2. CTags</strong>
    </div>
    <div style="color: #475569;">&rarr;</div>
    <div class="pipeline-box" style="border-color: #334155; min-width: 100px;">
      <strong class="dim">3. Detection</strong>
    </div>
    <div style="color: #475569;">&rarr;</div>
    <div class="pipeline-box" style="border-color: #334155; min-width: 100px;">
      <strong class="dim">4. Dedup</strong>
    </div>
    <div style="color: #475569;">&rarr;</div>
    <div class="pipeline-box" style="border-color: #334155; min-width: 100px;">
      <strong class="dim">5. Resolve</strong>
    </div>
    <div style="color: #475569;">&rarr;</div>
    <div class="pipeline-box active" style="min-width: 140px; border-color: #fbbf24;">
      <strong class="accent-amber">6. Concretise</strong><br>
      <span class="dim" style="font-size: 0.85em;">(varies)</span>
    </div>
  </div>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; font-size: 0.6em;">
    <div class="card" style="padding: 14px;">
      <h3 class="accent" style="font-size: 0.8em;">Two-Stage Classification</h3>
      <p style="font-size: 0.9em;">Every concretiser outputs the same structure:</p>
      <p style="font-size: 0.9em;"><strong>1. Validity:</strong> <span class="pill pill-green" style="font-size: 0.85em;">SIGNAL</span> or <span class="pill pill-blue" style="font-size: 0.85em;">NOISE</span></p>
      <p style="font-size: 0.9em;"><strong>2. Direction:</strong> <span class="pill pill-green" style="font-size: 0.85em;">INWARD</span> <span class="pill pill-amber" style="font-size: 0.85em;">OUTWARD</span> <span class="pill pill-blue" style="font-size: 0.85em;">AMBIGUOUS</span> <span class="pill pill-pink" style="font-size: 0.85em;">NOT_INTEGRATION</span></p>
    </div>
    <div class="card" style="padding: 14px;">
      <h3 class="accent-green" style="font-size: 0.8em;">Uniform Output</h3>
      <p style="font-size: 0.9em;">All pipelines return <code>ConcretisationResult</code> with:</p>
      <ul style="font-size: 0.85em; margin-top: 4px;">
        <li><code>concretised</code>: tuple of <code>ConcretisedSignal</code></li>
        <li><code>signals_submitted</code> / <code>classified</code> / <code>unclassified</code></li>
        <li>Per-signal metadata dict</li>
      </ul>
    </div>
  </div>
</section>

<!-- EXPERIMENT 1: ML CLASSIFIER -->
<section>
  <h2>Experiment 1: ML Classifier</h2>
  <h3>TF-IDF + Logistic Regression</h3>
  <div class="two-col">
    <div>
      <!-- flow diagram -->
      <div style="font-size: 0.55em; max-width: 340px;">
        <div class="pipeline-box" style="border-color: #fbbf24;">
          <strong class="accent-amber">Signal line content</strong><br>
          <code class="dim">"httpClient.get(url)"</code>
        </div>
        <div class="pipeline-arrow">&darr;</div>
        <div class="pipeline-box" style="border-color: #38bdf8;">
          <strong class="accent">TF-IDF Vectoriser</strong><br>
          <span class="dim">Word + char n-grams</span>
        </div>
        <div class="pipeline-arrow">&darr;</div>
        <div class="pipeline-box" style="border-color: #a78bfa;">
          <strong class="accent-purple">Logistic Regression</strong><br>
          <span class="dim">predict_proba()</span>
        </div>
        <div class="pipeline-arrow">&darr;</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 4px;">
          <div class="pipeline-box" style="border-color: #4ade80; padding: 6px;"><span class="accent-green" style="font-size: 0.85em;">INWARD</span></div>
          <div class="pipeline-box" style="border-color: #fbbf24; padding: 6px;"><span class="accent-amber" style="font-size: 0.85em;">OUTWARD</span></div>
          <div class="pipeline-box" style="border-color: #64748b; padding: 6px;"><span class="dim" style="font-size: 0.85em;">NOT_DEF</span></div>
          <div class="pipeline-box" style="border-color: #f472b6; padding: 6px;"><span class="accent-pink" style="font-size: 0.85em;">NOT_INT</span></div>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <h3 class="accent">Characteristics</h3>
        <ul>
          <li><strong>No API calls</strong> at inference &mdash; sklearn model serialised with joblib</li>
          <li>Trained on synthetic (Claude) + real (GitHub harvest) examples</li>
          <li>Falls back to <code>NullSignalClassifier</code> if model absent</li>
          <li>Outputs confidence via <code>predict_proba()</code></li>
        </ul>
      </div>
      <div class="card" style="margin-top: 10px;">
        <h3 class="accent-green">Trade-offs</h3>
        <table style="font-size: 0.75em;">
          <tr><td>Speed</td><td class="accent-green">Very fast (local sklearn)</td></tr>
          <tr><td>Cost</td><td class="accent-green">Free</td></tr>
          <tr><td>Accuracy</td><td class="accent-amber">Limited by training data</td></tr>
          <tr><td>Context</td><td class="accent-pink">Single line only</td></tr>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- EXPERIMENT 2: GENERIC EMBEDDING -->
<section>
  <h2>Experiment 2: Generic Embedding</h2>
  <h3>Cosine similarity against 26 directional descriptions</h3>
  <div class="two-col">
    <div>
      <!-- architecture diagram -->
      <div style="font-size: 0.5em; max-width: 380px;">
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 8px;">
          <div class="pipeline-box" style="border-color: #38bdf8;">
            <strong class="accent">Signal line</strong><br>
            <code class="dim" style="font-size: 0.8em;">app.get("/users")</code>
          </div>
          <div></div>
          <div class="pipeline-box" style="border-color: #4ade80;">
            <strong class="accent-green">26 Descriptions</strong><br>
            <span class="dim" style="font-size: 0.8em;">13 types &times; 2 dirs</span>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 8px; margin-top: 6px;">
          <div class="pipeline-arrow">&darr;</div>
          <div></div>
          <div class="pipeline-arrow">&darr;</div>
        </div>
        <div class="pipeline-box" style="border-color: #a78bfa; margin-top: 2px;">
          <strong class="accent-purple">Embedding API</strong><br>
          <span class="dim">HuggingFace (nomic-embed-code) or Gemini (gemini-embedding-001)</span>
        </div>
        <div class="pipeline-arrow">&darr;</div>
        <div class="pipeline-box" style="border-color: #fbbf24;">
          <strong class="accent-amber">Cosine Similarity Matrix</strong><br>
          <span class="dim">signal &times; 26 descriptions</span>
        </div>
        <div class="pipeline-arrow">&darr;</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
          <div class="pipeline-box" style="border-color: #38bdf8; padding: 8px;">
            <strong class="accent" style="font-size: 0.9em;">Gate</strong><br>
            <span class="dim">best_score &lt; 0.56<br>&rarr; NOISE</span>
          </div>
          <div class="pipeline-box" style="border-color: #4ade80; padding: 8px;">
            <strong class="accent-green" style="font-size: 0.9em;">Direction</strong><br>
            <span class="dim">inward / outward<br>score ratio &gt; 1.2&times;</span>
          </div>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <h3 class="accent">How it works</h3>
        <ol style="font-size: 0.75em;">
          <li>Pre-embed 26 natural-language descriptions<br><span class="dim">"Exposes an HTTP REST endpoint for incoming requests"</span></li>
          <li>Embed each signal's raw line content</li>
          <li>Compute cosine similarity: signal &times; 26 descriptions</li>
          <li><strong>Gate:</strong> best score &lt; 0.56 &rarr; NOISE</li>
          <li><strong>Direction:</strong> if inward_score &gt; outward_score &times; 1.2 &rarr; INWARD (and vice versa), else AMBIGUOUS</li>
        </ol>
      </div>
      <div class="card" style="margin-top: 10px;">
        <h3 class="accent-green">Trade-offs</h3>
        <table style="font-size: 0.75em;">
          <tr><td>Speed</td><td class="accent-green">Fast (batch 32 texts/call)</td></tr>
          <tr><td>Cost</td><td class="accent-green">Low (embedding API only)</td></tr>
          <tr><td>Gate accuracy</td><td class="accent-green">Good (clear threshold)</td></tr>
          <tr><td>Direction</td><td class="accent-amber">Weak (ratio heuristic)</td></tr>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- VISUAL: EMBEDDING VECTOR SPACE -->
<section>
  <h2>Embedding in Vector Space</h2>
  <h3>Nearest-neighbour classification via cosine similarity</h3>
  <svg viewBox="0 0 900 520" style="max-width: 820px; margin: 10px auto; display: block;"
       xmlns="http://www.w3.org/2000/svg" font-family="'Inter', system-ui, sans-serif">
    <!-- background grid -->
    <defs>
      <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
        <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#1e293b" stroke-width="0.5"/>
      </pattern>
      <!-- threshold circle gradient -->
      <radialGradient id="threshGrad" cx="50%" cy="50%" r="50%">
        <stop offset="85%" stop-color="transparent"/>
        <stop offset="100%" stop-color="rgba(56,189,248,0.06)"/>
      </radialGradient>
    </defs>
    <rect width="900" height="520" fill="#0f172a" rx="12"/>
    <rect x="60" y="30" width="780" height="450" fill="url(#grid)" rx="4"/>

    <!-- LEGEND -->
    <g font-size="11" class="fragment" data-fragment-index="0">
      <circle cx="80" cy="498" r="5" fill="#38bdf8"/>
      <text x="90" y="502" fill="#94a3b8">Code fragment</text>
      <circle cx="230" cy="498" r="5" fill="#4ade80"/>
      <text x="240" y="502" fill="#94a3b8">Inward description</text>
      <circle cx="410" cy="498" r="5" fill="#fbbf24"/>
      <text x="420" y="502" fill="#94a3b8">Outward description</text>
      <line x1="560" y1="498" x2="590" y2="498" stroke="#475569" stroke-width="1.5" stroke-dasharray="5,3"/>
      <text x="596" y="502" fill="#94a3b8">Similarity threshold (0.56)</text>
    </g>

    <!-- THRESHOLD CIRCLES (shown first to be behind points) -->
    <!-- threshold around app.get -->
    <circle cx="280" cy="180" r="120" fill="url(#threshGrad)" stroke="#334155" stroke-width="1" stroke-dasharray="6,4" class="fragment" data-fragment-index="2"/>
    <!-- threshold around db.connect -->
    <circle cx="620" cy="300" r="120" fill="url(#threshGrad)" stroke="#334155" stroke-width="1" stroke-dasharray="6,4" class="fragment" data-fragment-index="2"/>
    <!-- threshold around logger.info -->
    <circle cx="180" cy="380" r="120" fill="url(#threshGrad)" stroke="#334155" stroke-width="1" stroke-dasharray="6,4" class="fragment" data-fragment-index="4"/>

    <!-- ====== DESCRIPTION POINTS (green = inward, amber = outward) ====== -->
    <g class="fragment" data-fragment-index="1">
      <!-- Inward descriptions (green) -->
      <circle cx="250" cy="140" r="7" fill="#4ade80" opacity="0.9"/>
      <text x="258" y="134" font-size="10" fill="#4ade80">"HTTP route is registered"</text>

      <circle cx="600" cy="250" r="7" fill="#4ade80" opacity="0.9"/>
      <text x="610" y="244" font-size="10" fill="#4ade80">"DB connection is opened"</text>

      <circle cx="700" cy="120" r="7" fill="#4ade80" opacity="0.9"/>
      <text x="712" y="124" font-size="10" fill="#4ade80">"Queue is consumed"</text>

      <!-- Outward descriptions (amber) -->
      <circle cx="340" cy="100" r="7" fill="#fbbf24" opacity="0.9"/>
      <text x="350" y="94" font-size="10" fill="#fbbf24">"HTTP request is sent"</text>

      <circle cx="660" cy="350" r="7" fill="#fbbf24" opacity="0.9"/>
      <text x="670" y="366" font-size="10" fill="#fbbf24">"DB query is executed"</text>

      <circle cx="750" cy="180" r="7" fill="#fbbf24" opacity="0.9"/>
      <text x="710" y="200" font-size="10" fill="#fbbf24">"Message is published"</text>

      <!-- Scattered others for density -->
      <circle cx="480" cy="80" r="5" fill="#4ade80" opacity="0.5"/>
      <circle cx="520" cy="420" r="5" fill="#fbbf24" opacity="0.5"/>
      <circle cx="400" cy="350" r="5" fill="#4ade80" opacity="0.5"/>
      <circle cx="150" cy="100" r="5" fill="#fbbf24" opacity="0.5"/>
      <circle cx="770" cy="400" r="5" fill="#4ade80" opacity="0.5"/>
      <circle cx="350" cy="280" r="5" fill="#fbbf24" opacity="0.5"/>
    </g>

    <!-- ====== CODE FRAGMENT POINTS (cyan) ====== -->
    <g class="fragment" data-fragment-index="2">
      <!-- app.get("/users") â€” near "HTTP route is registered" (inward) -->
      <circle cx="280" cy="180" r="8" fill="#38bdf8" stroke="#0f172a" stroke-width="2"/>
      <text x="204" y="216" font-size="11" fill="#38bdf8" font-weight="600">app.get("/users")</text>

      <!-- db.connect(url, pwd) â€” near "DB connection is opened" (inward) -->
      <circle cx="620" cy="300" r="8" fill="#38bdf8" stroke="#0f172a" stroke-width="2"/>
      <text x="547" y="330" font-size="11" fill="#38bdf8" font-weight="600">db.connect(url, pwd)</text>

      <!-- logger.info("done") â€” isolated, nothing nearby -->
      <circle cx="180" cy="380" r="8" fill="#38bdf8" stroke="#0f172a" stroke-width="2"/>
      <text x="120" y="410" font-size="11" fill="#38bdf8" font-weight="600">logger.info("done")</text>
    </g>

    <!-- ====== NEAREST-NEIGHBOR LINES ====== -->
    <g class="fragment" data-fragment-index="3">
      <!-- app.get â†’ "HTTP route is registered" -->
      <line x1="280" y1="180" x2="250" y2="140" stroke="#4ade80" stroke-width="2" opacity="0.8"/>
      <g transform="translate(232, 162)">
        <rect x="0" y="-10" width="55" height="14" rx="3" fill="#14532d" opacity="0.9"/>
        <text x="28" y="0" font-size="9" fill="#86efac" text-anchor="middle" font-weight="600">cos = 0.81</text>
      </g>

      <!-- db.connect â†’ "DB connection is opened" -->
      <line x1="620" y1="300" x2="600" y2="250" stroke="#4ade80" stroke-width="2" opacity="0.8"/>
      <g transform="translate(585, 278)">
        <rect x="0" y="-10" width="55" height="14" rx="3" fill="#14532d" opacity="0.9"/>
        <text x="28" y="0" font-size="9" fill="#86efac" text-anchor="middle" font-weight="600">cos = 0.74</text>
      </g>
    </g>

    <!-- ====== CLASSIFICATION LABELS ====== -->
    <g class="fragment" data-fragment-index="3">
      <!-- app.get â†’ INWARD -->
      <g transform="translate(290, 230)">
        <rect x="0" y="-12" width="80" height="18" rx="9" fill="#14532d"/>
        <text x="40" y="0" font-size="10" fill="#86efac" text-anchor="middle" font-weight="700">&#x2192; INWARD</text>
      </g>
      <!-- db.connect â†’ INWARD -->
      <g transform="translate(630, 312)">
        <rect x="0" y="-12" width="80" height="18" rx="9" fill="#14532d"/>
        <text x="40" y="0" font-size="10" fill="#86efac" text-anchor="middle" font-weight="700">&#x2192; INWARD</text>
      </g>
    </g>

    <!-- ====== NOISE LABEL for logger.info ====== -->
    <g class="fragment" data-fragment-index="4">
      <!-- "no neighbour above threshold" annotation -->
      <g transform="translate(84, 440)">
        <rect x="0" y="-12" width="195" height="18" rx="9" fill="#1e293b" stroke="#475569" stroke-width="1"/>
        <text x="97" y="1" font-size="10" fill="#94a3b8" text-anchor="middle">No neighbour above threshold</text>
      </g>
      <g transform="translate(140, 460)">
        <rect x="0" y="-10" width="80" height="18" rx="9" fill="#451a03"/>
        <text x="40" y="2" font-size="10" fill="#fde68a" text-anchor="middle" font-weight="700">&#x2192; NOISE</text>
      </g>
    </g>
  </svg>
  <p class="small" style="margin-top: 4px;">Code and descriptions are embedded into the same vector space. The closest description (above the similarity threshold) determines the signal's direction. No close match &rarr; NOISE.</p>
</section>

<!-- EXPERIMENT 3: PATTERN EMBEDDING -->
<section>
  <h2>Experiment 3: Pattern Embedding</h2>
  <h3>Nearest-neighbor against ~3,430 pattern descriptions</h3>
  <div class="two-col">
    <div>
      <!-- comparison diagram: generic vs pattern -->
      <div style="font-size: 0.5em;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <div class="card" style="padding: 10px; border-color: #475569;">
            <h3 class="dim" style="font-size: 0.9em; margin-bottom: 6px;">Generic (Exp. 2)</h3>
            <div style="display: grid; grid-template-columns: 1fr; gap: 3px;">
              <div style="background: #0f172a; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">"Exposes HTTP REST endpoint"</div>
              <div style="background: #0f172a; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">"Consumes HTTP REST service"</div>
              <div class="dim" style="text-align: center;">&hellip; 24 more</div>
            </div>
            <p class="dim" style="margin-top: 6px; text-align: center;">26 targets</p>
          </div>
          <div class="card" style="padding: 10px; border-color: #f472b6;">
            <h3 class="accent-pink" style="font-size: 0.9em; margin-bottom: 6px;">Pattern (Exp. 3)</h3>
            <div style="display: grid; grid-template-columns: 1fr; gap: 3px;">
              <div style="background: #0f172a; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">"Spring @GetMapping handler"</div>
              <div style="background: #0f172a; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">"FastAPI route decorator"</div>
              <div style="background: #0f172a; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">"KafkaTemplate send call"</div>
              <div class="dim" style="text-align: center;">&hellip; ~3,427 more</div>
            </div>
            <p class="accent-pink" style="margin-top: 6px; text-align: center;">~3,430 targets</p>
          </div>
        </div>
        <div class="pipeline-arrow" style="margin-top: 8px;">&darr;</div>
        <div class="pipeline-box" style="border-color: #f472b6; margin-top: 2px;">
          <strong class="accent-pink">Nearest Neighbour</strong><br>
          <span class="dim">Direction = nearest description's <code>SignalDirection</code></span>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <h3 class="accent-pink">Key Insight</h3>
        <p>Each regex pattern carries two descriptions (inward + outward). Embedding against <strong>pattern-specific semantics</strong> captures framework-level nuance that generic descriptions miss.</p>
      </div>
      <div class="card" style="margin-top: 10px;">
        <h3 class="accent">Embedding Cache</h3>
        <ul style="font-size: 0.75em;">
          <li>Pre-build: <code>pipeline/build_pattern_embeddings.py</code></li>
          <li>Saved as JSON with <strong>SHA-256 content hash</strong></li>
          <li>Auto-invalidates when patterns change</li>
          <li>Skips ~2 min API warm-up on subsequent runs</li>
        </ul>
        <pre style="font-size: 0.6em; margin-top: 6px;"><code class="language-bash">poetry run python pipeline/build_pattern_embeddings.py \
    --backend gemini</code></pre>
      </div>
      <div class="card" style="margin-top: 10px;">
        <h3 class="accent-green">Trade-offs</h3>
        <table style="font-size: 0.75em;">
          <tr><td>Targets</td><td class="accent-green">~3,430 (vs 26)</td></tr>
          <tr><td>Direction</td><td class="accent-green">Nearest-neighbor (no ratio)</td></tr>
          <tr><td>Warm-up</td><td class="accent-green">Cached (skip on re-run)</td></tr>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- EXPERIMENT 4: OLLAMA (LOCAL LLM) -->
<section>
  <h2>Experiment 4: Ollama</h2>
  <h3>Local LLM with full file context</h3>
  <div class="two-col">
    <div>
      <div style="font-size: 0.5em; max-width: 360px;">
        <div class="pipeline-box" style="border-color: #a78bfa;">
          <strong class="accent-purple">Signals grouped by file</strong>
        </div>
        <div class="pipeline-arrow">&darr;</div>
        <div class="pipeline-box" style="border-color: #a78bfa; text-align: left; padding: 10px 16px;">
          <strong class="accent-purple">Prompt per file</strong><br>
          <span class="dim" style="font-size: 0.85em; display: block; margin-top: 4px;">
            File: <code>OrderService.java</code><br>
            Signal lines to classify:<br>
            &nbsp;&nbsp;Line 12: [http_rest] @GetMapping<br>
            &nbsp;&nbsp;Line 45: [messaging] kafkaTemplate.send()<br>
            File content: <span style="opacity: 0.5;">&lt;full file, &le;12K chars&gt;</span>
          </span>
        </div>
        <div class="pipeline-arrow">&darr;</div>
        <div class="pipeline-box" style="border-color: #a78bfa;">
          <strong class="accent-purple">Ollama HTTP API</strong><br>
          <span class="dim">qwen2.5-coder:7b-instruct<br>localhost:11434 &middot; 180s timeout</span>
        </div>
        <div class="pipeline-arrow">&darr;</div>
        <div class="pipeline-box" style="border-color: #4ade80; text-align: left; padding: 10px 16px;">
          <strong class="accent-green">JSON response</strong><br>
          <span class="dim" style="font-size: 0.85em; display: block; margin-top: 4px;">
            { label: "DEFINITE_INWARD",<br>
            &nbsp;&nbsp;confidence: 0.92,<br>
            &nbsp;&nbsp;reason: "REST endpoint via Spring" }
          </span>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <h3 class="accent-purple">Approach</h3>
        <ul>
          <li>Sends <strong>entire file content</strong> (truncated at 12K chars) plus signal line markers</li>
          <li>LLM reasons about imports, class structure, and surrounding code</li>
          <li>Returns structured JSON: <code>label</code>, <code>confidence</code>, <code>reason</code></li>
          <li>One API call per file (not per signal)</li>
        </ul>
      </div>
      <div class="card" style="margin-top: 10px;">
        <h3 class="accent">Label Mapping</h3>
        <table style="font-size: 0.7em;">
          <tr><th>LLM Label</th><th>Validity</th><th>Direction</th></tr>
          <tr><td><code>DEFINITE_INWARD</code></td><td class="accent-green">SIGNAL</td><td class="accent-green">INWARD</td></tr>
          <tr><td><code>DEFINITE_OUTWARD</code></td><td class="accent-green">SIGNAL</td><td class="accent-amber">OUTWARD</td></tr>
          <tr><td><code>NOT_DEFINITE</code></td><td class="accent-green">SIGNAL</td><td class="dim">AMBIGUOUS</td></tr>
          <tr><td><code>NOT_INTEGRATION</code></td><td class="dim">NOISE</td><td class="accent-pink">NOT_INT</td></tr>
        </table>
      </div>
      <div class="card" style="margin-top: 10px;">
        <h3 class="accent-green">Trade-offs</h3>
        <table style="font-size: 0.75em;">
          <tr><td>Speed</td><td class="accent-pink">Slow (local inference)</td></tr>
          <tr><td>Cost</td><td class="accent-green">Free (local)</td></tr>
          <tr><td>Context</td><td class="accent-green">Full file</td></tr>
          <tr><td>Setup</td><td class="accent-amber">Requires Ollama server</td></tr>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- EXPERIMENT 5: GEMINI FLASH -->
<section>
  <h2>Experiment 5: Gemini Flash</h2>
  <h3>Cloud LLM with multi-file batching</h3>
  <div class="two-col">
    <div>
      <!-- batching diagram -->
      <div style="font-size: 0.5em; max-width: 380px;">
        <div class="pipeline-box" style="border-color: #4ade80;">
          <strong class="accent-green">Files with signals</strong>
        </div>
        <div class="pipeline-arrow">&darr;</div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
          <div class="pipeline-box" style="border-color: #fbbf24; padding: 8px;">
            <strong class="accent-amber" style="font-size: 0.9em;">Solo files</strong><br>
            <span class="dim" style="font-size: 0.85em;">&gt; 80K chars<br>1 API call each</span>
          </div>
          <div class="pipeline-box" style="border-color: #4ade80; padding: 8px;">
            <strong class="accent-green" style="font-size: 0.9em;">Batchable files</strong><br>
            <span class="dim" style="font-size: 0.85em;">&le; 80K combined<br>N files &rarr; 1 call</span>
          </div>
        </div>
        <div class="pipeline-arrow">&darr;</div>
        <div class="pipeline-box" style="border-color: #4ade80; text-align: left; padding: 10px 16px;">
          <strong class="accent-green">Batched prompt</strong><br>
          <span class="dim" style="font-size: 0.85em; display: block; margin-top: 4px;">
            ===FILE: OrderService.java===<br>
            &nbsp;&nbsp;Line 12: [http_rest] @GetMapping<br>
            &nbsp;&nbsp;<span style="opacity: 0.5;">&lt;file content&gt;</span><br>
            ===FILE: UserController.java===<br>
            &nbsp;&nbsp;Line 5: [http_rest] @PostMapping<br>
            &nbsp;&nbsp;<span style="opacity: 0.5;">&lt;file content&gt;</span>
          </span>
        </div>
        <div class="pipeline-arrow">&darr;</div>
        <div class="pipeline-box" style="border-color: #4ade80;">
          <strong class="accent-green">Gemini Flash API</strong><br>
          <span class="dim">gemini-2.5-flash &middot; structured JSON &middot; exponential backoff</span>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <h3 class="accent-green">Smart Batching</h3>
        <p>Files are partitioned into three categories:</p>
        <ol style="font-size: 0.75em;">
          <li><strong>Solo</strong>: File + prompt &gt; 80K chars &rarr; own API call</li>
          <li><strong>Batchable</strong>: Multiple files grouped until 80K limit</li>
          <li><strong>Unreadable</strong>: Marked as NOISE automatically</li>
        </ol>
        <p class="dim" style="margin-top: 8px;">Reduces API round-trips by <strong>5&ndash;7&times;</strong> on typical repos.</p>
      </div>
      <div class="card" style="margin-top: 10px;">
        <h3 class="accent">vs. Ollama</h3>
        <ul style="font-size: 0.75em;">
          <li>Same prompt format and label mapping</li>
          <li>Shared prompt/parsing logic in <code>llm_shared.py</code></li>
          <li>Adds <strong>multi-file batching</strong> (Ollama is per-file only)</li>
          <li>Exponential backoff on rate limits (5 retries)</li>
        </ul>
      </div>
      <div class="card" style="margin-top: 10px;">
        <h3 class="accent-green">Trade-offs</h3>
        <table style="font-size: 0.75em;">
          <tr><td>Speed</td><td class="accent-green">Fast (cloud + batching)</td></tr>
          <tr><td>Cost</td><td class="accent-amber">Medium (LLM API)</td></tr>
          <tr><td>Context</td><td class="accent-green">Full file + batched</td></tr>
          <tr><td>Accuracy</td><td class="accent-green">High (LLM reasoning)</td></tr>
        </table>
      </div>
    </div>
  </div>
</section>

<!-- EXPERIMENT 6: HYBRID - THE KEY INSIGHT -->
<section>
  <h2>Experiment 6: Hybrid Pipeline</h2>
  <h3>Embedding gate + Gemini Flash direction</h3>
  <p style="font-size: 0.65em; margin-top: 10px;">Observation: embeddings are <strong>good at SIGNAL/NOISE gating</strong> but poor at direction. Gemini is <strong>excellent at direction</strong> but expensive. Combine them.</p>
  <!-- three-phase flow diagram -->
  <div style="display: grid; grid-template-columns: 1fr auto 1fr auto 1fr; align-items: start; gap: 8px; margin-top: 16px; font-size: 0.5em;">
    <div>
      <div class="pipeline-box" style="border-color: #38bdf8;">
        <strong class="accent">Phase 2a: Embedding Gate</strong>
      </div>
      <div style="padding: 8px; margin-top: 4px;">
        <span class="dim">All signals &rarr; GenericIntegrationDescriptionEmbeddingConcretiser</span><br><br>
        <span class="pill pill-green" style="font-size: 0.9em;">SIGNAL (42)</span><br>
        <span class="pill pill-blue" style="font-size: 0.9em;">NOISE (158)</span>
      </div>
    </div>
    <div style="font-size: 2em; color: #475569; margin-top: 20px;">&rarr;</div>
    <div>
      <div class="pipeline-box" style="border-color: #4ade80;">
        <strong class="accent-green">Phase 2b: Gemini Direction</strong>
      </div>
      <div style="padding: 8px; margin-top: 4px;">
        <span class="dim">Only SIGNALs &rarr; Gemini Flash</span><br><br>
        <span class="pill pill-green" style="font-size: 0.9em;">INWARD (18)</span><br>
        <span class="pill pill-amber" style="font-size: 0.9em;">OUTWARD (15)</span><br>
        <span class="pill pill-blue" style="font-size: 0.9em;">AMBIGUOUS (5)</span><br>
        <span class="pill pill-pink" style="font-size: 0.9em;">NOT_INT (4)</span>
      </div>
    </div>
    <div style="font-size: 2em; color: #475569; margin-top: 20px;">&rarr;</div>
    <div>
      <div class="pipeline-box" style="border-color: #fbbf24;">
        <strong class="accent-amber">Phase 2c: Merge</strong>
      </div>
      <div style="padding: 8px; margin-top: 4px;">
        <span class="dim">Embedding validity<br>+ Gemini direction</span><br><br>
        <span class="dim" style="font-size: 0.85em;">Embedding: <strong>authority on validity</strong><br>Gemini: <strong>authority on direction</strong></span>
      </div>
    </div>
  </div>
</section>

<!-- HYBRID: MERGE LOGIC DETAIL -->
<section>
  <h2>Hybrid: Merge Logic</h2>
  <h3>How embedding validity and Gemini direction combine</h3>
  <div class="two-col">
    <div>
      <!-- decision tree diagram -->
      <div style="font-size: 0.5em; max-width: 400px;">
        <div class="pipeline-box" style="border-color: #38bdf8;">
          <strong class="accent">Embedding says?</strong>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 8px;">
          <!-- NOISE branch -->
          <div>
            <div style="text-align: center; color: #ef4444; font-weight: 600; margin-bottom: 4px;">NOISE</div>
            <div class="pipeline-box" style="border-color: #64748b; background: #0f172a;">
              <span class="dim">Keep as NOISE<br>Direction = AMBIGUOUS</span><br>
              <span style="color: #64748b; font-size: 0.85em;">Gemini result ignored</span>
            </div>
          </div>
          <!-- SIGNAL branch -->
          <div>
            <div style="text-align: center; color: #4ade80; font-weight: 600; margin-bottom: 4px;">SIGNAL</div>
            <div class="pipeline-box" style="border-color: #4ade80;">
              <strong class="accent-green">Gemini says?</strong>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 6px; font-size: 0.9em;">
              <div class="pipeline-box" style="padding: 6px; border-color: #4ade80;">
                <span class="accent-green">INWARD<br>OUTWARD</span><br>
                <span class="dim" style="font-size: 0.8em;">Use Gemini's direction</span>
              </div>
              <div class="pipeline-box" style="padding: 6px; border-color: #f472b6;">
                <span class="accent-pink">NOT_INT</span><br>
                <span class="dim" style="font-size: 0.8em;">Keep NOT_INTEGRATION</span>
              </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 4px; font-size: 0.9em;">
              <div class="pipeline-box" style="padding: 6px; border-color: #64748b;">
                <span class="dim">NOT_DEF</span><br>
                <span class="dim" style="font-size: 0.8em;">dir = AMBIGUOUS</span>
              </div>
              <div class="pipeline-box" style="padding: 6px; border-color: #64748b;">
                <span class="dim">Missing</span><br>
                <span class="dim" style="font-size: 0.8em;">dir = AMBIGUOUS</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div>
      <div class="card">
        <h3 class="accent-amber">Merge Rules</h3>
        <table style="font-size: 0.65em;">
          <tr><th>Embedding</th><th>Gemini</th><th>Result</th></tr>
          <tr><td>NOISE</td><td><span class="dim">(any)</span></td><td>NOISE / AMBIGUOUS</td></tr>
          <tr><td>SIGNAL</td><td>INWARD</td><td>SIGNAL / <span class="accent-green">INWARD</span></td></tr>
          <tr><td>SIGNAL</td><td>OUTWARD</td><td>SIGNAL / <span class="accent-amber">OUTWARD</span></td></tr>
          <tr><td>SIGNAL</td><td>NOT_DEFINITE</td><td>SIGNAL / <span class="dim">AMBIGUOUS</span></td></tr>
          <tr><td>SIGNAL</td><td>NOT_INT</td><td>SIGNAL / <span class="accent-pink">NOT_INT</span></td></tr>
          <tr><td>SIGNAL</td><td><span class="dim">missing</span></td><td>SIGNAL / <span class="dim">AMBIGUOUS</span></td></tr>
        </table>
      </div>
      <div class="card" style="margin-top: 10px;">
        <h3 class="accent-green">Cost Optimisation</h3>
        <p style="font-size: 0.75em;">In a typical repo with 200 signals:</p>
        <ul style="font-size: 0.7em;">
          <li>Embedding gate classifies 158 as NOISE (cheap)</li>
          <li>Only <strong>42 SIGNALs</strong> sent to Gemini (expensive)</li>
          <li>&rarr; <strong>79% fewer</strong> LLM API calls</li>
        </ul>
      </div>
    </div>
  </div>
</section>

<!-- COMPARISON TABLE -->
<section>
  <h2>Experiment Comparison</h2>
  <table style="font-size: 0.52em;">
    <tr>
      <th></th>
      <th>ML Classifier</th>
      <th>Generic Emb.</th>
      <th>Pattern Emb.</th>
      <th>Ollama</th>
      <th>Gemini Flash</th>
      <th>Hybrid</th>
    </tr>
    <tr>
      <td style="font-weight: 600;">Inference</td>
      <td>Local (sklearn)</td>
      <td>API (embeddings)</td>
      <td>API (cached)</td>
      <td>Local HTTP</td>
      <td>Cloud HTTP</td>
      <td>API + Cloud</td>
    </tr>
    <tr>
      <td style="font-weight: 600;">Targets</td>
      <td>Learned features</td>
      <td>26 descriptions</td>
      <td class="accent-green">~3,430 descriptions</td>
      <td>Full file context</td>
      <td>Full file context</td>
      <td>26 + full file</td>
    </tr>
    <tr>
      <td style="font-weight: 600;">Direction</td>
      <td>Logistic regression</td>
      <td>Score ratio (1.2&times;)</td>
      <td class="accent-green">Nearest neighbour</td>
      <td class="accent-green">LLM reasoning</td>
      <td class="accent-green">LLM reasoning</td>
      <td class="accent-green">LLM reasoning</td>
    </tr>
    <tr>
      <td style="font-weight: 600;">Speed</td>
      <td class="accent-green">Very fast</td>
      <td class="accent-green">Fast</td>
      <td class="accent-green">Fast</td>
      <td class="accent-pink">Slow</td>
      <td class="accent-amber">Medium</td>
      <td class="accent-amber">Medium</td>
    </tr>
    <tr>
      <td style="font-weight: 600;">Cost</td>
      <td class="accent-green">Free</td>
      <td class="accent-green">Low</td>
      <td class="accent-green">Low (cached)</td>
      <td class="accent-green">Free</td>
      <td class="accent-amber">Medium</td>
      <td class="accent-green">Low&ndash;Med</td>
    </tr>
    <tr>
      <td style="font-weight: 600;">Batching</td>
      <td>&mdash;</td>
      <td>32 texts</td>
      <td>32 texts</td>
      <td>Per-file</td>
      <td class="accent-green">Multi-file (80K)</td>
      <td>32 + multi-file</td>
    </tr>
    <tr>
      <td style="font-weight: 600;">Context</td>
      <td class="accent-pink">Single line</td>
      <td class="accent-pink">Single line</td>
      <td class="accent-pink">Single line</td>
      <td class="accent-green">Full file</td>
      <td class="accent-green">Full file</td>
      <td class="accent-green">Line + file</td>
    </tr>
    <tr>
      <td style="font-weight: 600;">Caching</td>
      <td>Model on disk</td>
      <td>&mdash;</td>
      <td class="accent-green">SHA-256 JSON</td>
      <td>&mdash;</td>
      <td>&mdash;</td>
      <td>&mdash;</td>
    </tr>
  </table>
  <p class="small" style="margin-top: 12px;">All pipelines output identical <code>ConcretisationResult</code> objects &mdash; consumers are agnostic to the classification method.</p>
</section>

<!-- SPEED vs ACCURACY SCATTER PLOT -->
<section>
  <h2>Speed vs. Accuracy Trade-offs</h2>
  <h3>Where each experiment sits in the design space</h3>
  <svg viewBox="0 0 900 520" style="max-width: 820px; margin: 8px auto; display: block;"
       xmlns="http://www.w3.org/2000/svg" font-family="'Inter', system-ui, sans-serif">
    <rect width="900" height="520" fill="#0f172a" rx="12"/>

    <!-- axes -->
    <line x1="100" y1="440" x2="850" y2="440" stroke="#475569" stroke-width="1.5"/>
    <line x1="100" y1="440" x2="100" y2="50" stroke="#475569" stroke-width="1.5"/>
    <!-- arrowheads -->
    <polygon points="850,440 840,435 840,445" fill="#475569"/>
    <polygon points="100,50 95,60 105,60" fill="#475569"/>

    <!-- axis labels -->
    <text x="480" y="485" font-size="13" fill="#94a3b8" text-anchor="middle" font-weight="600">Speed &#x2192;</text>
    <text x="42" y="250" font-size="13" fill="#94a3b8" text-anchor="middle" font-weight="600" transform="rotate(-90, 42, 250)">Accuracy &#x2192;</text>

    <!-- axis tick labels -->
    <text x="180" y="462" font-size="10" fill="#64748b" text-anchor="middle">Slow</text>
    <text x="480" y="462" font-size="10" fill="#64748b" text-anchor="middle">Medium</text>
    <text x="780" y="462" font-size="10" fill="#64748b" text-anchor="middle">Fast</text>
    <text x="88" y="390" font-size="10" fill="#64748b" text-anchor="end">Low</text>
    <text x="88" y="250" font-size="10" fill="#64748b" text-anchor="end">Medium</text>
    <text x="88" y="110" font-size="10" fill="#64748b" text-anchor="end">High</text>

    <!-- grid lines (subtle) -->
    <line x1="100" y1="385" x2="850" y2="385" stroke="#1e293b" stroke-width="0.5" stroke-dasharray="4,4"/>
    <line x1="100" y1="245" x2="850" y2="245" stroke="#1e293b" stroke-width="0.5" stroke-dasharray="4,4"/>
    <line x1="100" y1="105" x2="850" y2="105" stroke="#1e293b" stroke-width="0.5" stroke-dasharray="4,4"/>
    <line x1="180" y1="50" x2="180" y2="440" stroke="#1e293b" stroke-width="0.5" stroke-dasharray="4,4"/>
    <line x1="480" y1="50" x2="480" y2="440" stroke="#1e293b" stroke-width="0.5" stroke-dasharray="4,4"/>
    <line x1="780" y1="50" x2="780" y2="440" stroke="#1e293b" stroke-width="0.5" stroke-dasharray="4,4"/>

    <!-- ====== DATA POINTS ====== -->

    <!-- 1. ML Classifier: very fast, low-medium accuracy -->
    <g class="fragment" data-fragment-index="0">
      <circle cx="790" cy="330" r="12" fill="#fbbf24" opacity="0.9"/>
      <text x="790" y="335" font-size="11" fill="#0f172a" text-anchor="middle" font-weight="700">1</text>
      <!-- label -->
      <g transform="translate(710, 290)">
        <rect x="0" y="-13" width="106" height="32" rx="6" fill="#1e293b" stroke="#fbbf24" stroke-width="1"/>
        <text x="53" y="0" font-size="10" fill="#fbbf24" text-anchor="middle" font-weight="600">ML Classifier</text>
        <text x="53" y="12" font-size="8" fill="#94a3b8" text-anchor="middle">Free, single-line only</text>
      </g>
      <line x1="763" y1="310" x2="790" y2="325" stroke="#fbbf24" stroke-width="0.8" opacity="0.5"/>
    </g>

    <!-- 2. Generic Embedding: fast, medium accuracy -->
    <g class="fragment" data-fragment-index="1">
      <circle cx="700" cy="240" r="12" fill="#38bdf8" opacity="0.9"/>
      <text x="700" y="245" font-size="11" fill="#0f172a" text-anchor="middle" font-weight="700">2</text>
      <g transform="translate(710, 210)">
        <rect x="0" y="-13" width="120" height="32" rx="6" fill="#1e293b" stroke="#38bdf8" stroke-width="1"/>
        <text x="60" y="0" font-size="10" fill="#38bdf8" text-anchor="middle" font-weight="600">Generic Embedding</text>
        <text x="60" y="12" font-size="8" fill="#94a3b8" text-anchor="middle">Good gate, weak direction</text>
      </g>
      <line x1="710" y1="232" x2="703" y2="236" stroke="#38bdf8" stroke-width="0.8" opacity="0.5"/>
    </g>

    <!-- 3. Pattern Embedding: fast, medium-high accuracy -->
    <g class="fragment" data-fragment-index="2">
      <circle cx="680" cy="160" r="12" fill="#f472b6" opacity="0.9"/>
      <text x="680" y="165" font-size="11" fill="#0f172a" text-anchor="middle" font-weight="700">3</text>
      <g transform="translate(700, 140)">
        <rect x="0" y="-13" width="140" height="32" rx="6" fill="#1e293b" stroke="#f472b6" stroke-width="1"/>
        <text x="70" y="0" font-size="10" fill="#f472b6" text-anchor="middle" font-weight="600">Pattern Embedding</text>
        <text x="70" y="12" font-size="8" fill="#94a3b8" text-anchor="middle">~3,430 targets, cached</text>
      </g>
      <line x1="700" y1="156" x2="690" y2="158" stroke="#f472b6" stroke-width="0.8" opacity="0.5"/>
    </g>

    <!-- 4. Ollama: slow, medium-high accuracy -->
    <g class="fragment" data-fragment-index="3">
      <circle cx="170" cy="180" r="12" fill="#a78bfa" opacity="0.9"/>
      <text x="170" y="185" font-size="11" fill="#0f172a" text-anchor="middle" font-weight="700">4</text>
      <g transform="translate(190, 162)">
        <rect x="0" y="-13" width="136" height="32" rx="6" fill="#1e293b" stroke="#a78bfa" stroke-width="1"/>
        <text x="68" y="0" font-size="10" fill="#a78bfa" text-anchor="middle" font-weight="600">Ollama (Local LLM)</text>
        <text x="68" y="12" font-size="8" fill="#94a3b8" text-anchor="middle">Full context, GPU-bound</text>
      </g>
      <line x1="190" y1="180" x2="182" y2="180" stroke="#a78bfa" stroke-width="0.8" opacity="0.5"/>
    </g>

    <!-- 5. Gemini Flash: medium speed, high accuracy -->
    <g class="fragment" data-fragment-index="4">
      <circle cx="440" cy="90" r="12" fill="#4ade80" opacity="0.9"/>
      <text x="440" y="95" font-size="11" fill="#0f172a" text-anchor="middle" font-weight="700">5</text>
      <g transform="translate(310, 72)">
        <rect x="0" y="-13" width="122" height="32" rx="6" fill="#1e293b" stroke="#4ade80" stroke-width="1"/>
        <text x="61" y="0" font-size="10" fill="#4ade80" text-anchor="middle" font-weight="600">Gemini Flash</text>
        <text x="61" y="12" font-size="8" fill="#94a3b8" text-anchor="middle">Best accuracy, costly</text>
      </g>
      <line x1="432" y1="88" x2="432" y2="92" stroke="#4ade80" stroke-width="0.8" opacity="0.5"/>
    </g>

    <!-- 6. Hybrid: medium speed, high accuracy -->
    <g class="fragment" data-fragment-index="5">
      <circle cx="520" cy="100" r="14" fill="#fbbf24" stroke="#4ade80" stroke-width="3" opacity="0.95"/>
      <text x="520" y="105" font-size="11" fill="#0f172a" text-anchor="middle" font-weight="700">6</text>
      <g transform="translate(540, 82)">
        <rect x="0" y="-13" width="170" height="44" rx="6" fill="#1e293b" stroke="#fbbf24" stroke-width="1.5"/>
        <text x="85" y="1" font-size="10" fill="#fbbf24" text-anchor="middle" font-weight="700">Hybrid (Emb + Gemini)</text>
        <text x="85" y="14" font-size="8" fill="#94a3b8" text-anchor="middle">79% fewer LLM calls</text>
        <text x="85" y="25" font-size="8" fill="#94a3b8" text-anchor="middle">Best cost/accuracy balance</text>
      </g>
      <line x1="540" y1="100" x2="534" y2="100" stroke="#fbbf24" stroke-width="0.8" opacity="0.5"/>
    </g>

    <!-- ====== PARETO FRONTIER (dashed curve) ====== -->
    <g class="fragment" data-fragment-index="6">
      <path d="M 440,90 C 500,88 550,95 680,160 Q 720,190 700,240 Q 710,280 790,330"
            fill="none" stroke="#fde68a" stroke-width="1.5" stroke-dasharray="6,4" opacity="0.5"/>
      <text x="620" y="82" font-size="10" fill="#fde68a" opacity="0.7" font-style="italic">Pareto frontier</text>
    </g>

    <!-- ====== ANNOTATION: ideal corner ====== -->
    <g class="fragment" data-fragment-index="6">
      <text x="830" y="75" font-size="22" fill="#334155" text-anchor="end" font-weight="700" opacity="0.4">&#x2606;</text>
      <text x="826" y="92" font-size="9" fill="#475569" text-anchor="end" font-style="italic">ideal</text>
    </g>
  </svg>
  <p class="small" style="margin-top: 2px;">Speed reflects wall-clock throughput for a typical 200-signal repo. Accuracy reflects combined gate + direction quality from smojol-api ground truth (22 signals).</p>
</section>

<!-- PIPELINE EVOLUTION DIAGRAM -->
<section>
  <h2>Evolution of the Approach</h2>
  <h3>Each experiment addressed a weakness of the previous one</h3>
  <div style="font-size: 0.52em; max-width: 900px; margin: 0 auto;">
    <div style="display: grid; grid-template-columns: auto 1fr auto 1fr auto; align-items: center; gap: 4px;">
      <div class="pipeline-box" style="border-color: #fbbf24; min-width: 130px;">
        <strong class="accent-amber">ML Classifier</strong><br>
        <span class="dim">Fast, free, but<br>limited by training data</span>
      </div>
      <div style="text-align: center; color: #475569;">&xrarr;</div>
      <div class="pipeline-box" style="border-color: #a78bfa; min-width: 130px;">
        <strong class="accent-purple">Ollama</strong><br>
        <span class="dim">Full context, but<br>slow &amp; local only</span>
      </div>
      <div style="text-align: center; color: #475569;">&xrarr;</div>
      <div class="pipeline-box" style="border-color: #4ade80; min-width: 130px;">
        <strong class="accent-green">Gemini Flash</strong><br>
        <span class="dim">Fast cloud LLM +<br>batching, but costly</span>
      </div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 14px;">
      <div style="text-align: center;">
        <div style="color: #475569; margin-bottom: 4px;">&darr; <span class="dim">Can we avoid LLM calls entirely?</span></div>
        <div class="pipeline-box" style="border-color: #38bdf8;">
          <strong class="accent">Generic Embedding</strong><br>
          <span class="dim">Cheap embedding API, good gate,<br>but weak direction</span>
        </div>
        <div style="color: #475569; margin-top: 4px;">&darr; <span class="dim">Richer targets?</span></div>
        <div class="pipeline-box" style="border-color: #f472b6;">
          <strong class="accent-pink">Pattern Embedding</strong><br>
          <span class="dim">~3,430 targets, cached,<br>better direction via nearest-neighbor</span>
        </div>
      </div>
      <div style="text-align: center;">
        <div style="color: #475569; margin-bottom: 4px;">&darr; <span class="dim">Can we get LLM accuracy cheaply?</span></div>
        <div class="pipeline-box" style="border-color: #fbbf24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);">
          <strong class="accent-amber">Hybrid</strong><br>
          <span class="dim">Embedding gate (cheap) filters noise,<br>Gemini (expensive) on SIGNALs only<br><strong>Best of both worlds</strong></span>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- NEO4J GRAPH MODEL -->
<section>
  <h2>Neo4j Graph Model</h2>
  <div style="font-size: 0.7em; max-width: 700px; margin: 0 auto;">
    <pre><code class="nohighlight" style="background: #1e293b;">
  (Repository)
       |
       |â”€â”€ CONTAINS_DIRECTORY â”€â”€â–¶ (Directory)
       |                              |
       |â”€â”€ CONTAINS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ (CodeSymbol)
                                      |
                                      |â”€â”€ HAS_INTEGRATION â”€â”€â–¶ (IntegrationSignal)
                                                                    |
                                                                    |â”€â”€ OF_TYPE â”€â”€â–¶ (IntegrationType)
                                                                    |
                                                                    |â”€â”€ MATCHED_BY â”€â”€â–¶ (PatternMatch)
    </code></pre>
  </div>
  <p style="margin-top: 15px;">Accessed via a <code>Neo4jDriver</code> <strong>Protocol</strong> &mdash; dependency-injected, not hardcoded.</p>
  <p class="small">Enables graph queries: "show me all symbols that consume Kafka and expose REST endpoints"</p>
</section>

<!-- DATALOG SECTION DIVIDER -->
<section class="section-divider">
  <h2>Datalog Emission &amp; Query</h2>
  <h3>Turning parse trees into a queryable database</h3>
</section>

<!-- DATALOG: FROM SOURCE TO FACTS -->
<section>
  <h2>Source &rarr; Facts &rarr; Queries</h2>
  <p>Single-pass DFS over the tree-sitter AST emits <strong>16 Datalog relations</strong>. Souffl&eacute; evaluates derived rules.</p>
  <div class="two-col" style="margin-top: 10px;">
    <div>
      <pre style="font-size: 0.45em;"><code class="language-java">public class OrderService {
    private final OrderRepository repo;
    public Order findById(long id) {
        return repo.findById(id)
            .orElseThrow(() ->
                new OrderNotFoundException(id));
    }
}</code></pre>
    </div>
    <div>
      <pre style="font-size: 0.45em;"><code class="language-prolog">% Structure
scope(1, "class_declaration").
scope(5, "method_declaration").
scope_parent(5, 1).
% Identity
name(12, "findById").
declared_type(5, "Order").
% Use-def
refers_to(28, 3).  % "repo" ref â†’ decl
% Calls &amp; instantiations
call(20, 18, "findById").
call(22, 20, "orElseThrow").
instantiation(25, "OrderNotFoundException").</code></pre>
    </div>
  </div>
  <p class="small" style="margin-top: 6px;">Language-specific node types injected via <strong>bridge facts</strong> from a plugin &mdash; <code>analysis.dl</code> has zero hardcoded strings.</p>
</section>

<!-- DATALOG: QUERY EXAMPLES - STRUCTURAL -->
<section>
  <h2>Query: "What's visible inside findById()?"</h2>
  <div class="two-col">
    <div>
      <p>The Datalog rule <span class="small">(defined once in <code>analysis.dl</code>)</span>:</p>
      <pre style="font-size: 0.52em;"><code class="language-prolog">visible_from(S, D) :- declares(S, D).
visible_from(S, D) :-
    scope_chain(S, P), declares(P, D).</code></pre>
      <p style="margin-top: 12px;">Two more used in this slide:</p>
      <pre style="font-size: 0.52em;"><code class="language-prolog">method_decl(N, MName) :-
    callable_node_type(T), node(N, T),
    field(N, "name", NameNode),
    name(NameNode, MName).

typed_decl(D, VName, TText) :-
    declaration(D), name(D, VName),
    field(Parent, "name", D),
    declared_type(Parent, TText).</code></pre>
    </div>
    <div>
      <p><strong>Actual Souffl&eacute; output</strong> for <code>OrderService</code>:</p>
      <pre style="font-size: 0.52em;"><code class="nohighlight">$ cat output/visible_from.csv | grep "^50"
# scope 50 = findById() body
50  5     â† OrderService  (from class scope)
50  14    â† repo           (from class_body scope)
50  42    â† findById        (own method name)
50  48    â† id              (own parameter)

$ cat output/method_decl.csv
16  OrderService    â† constructor
38  findById
82  createOrder

$ cat output/typed_decl.csv
14   repo         OrderRepository
48   id           long
91   customerId   String
100  items        List&lt;Item&gt;
135  order        Order</code></pre>
    </div>
  </div>
</section>

<!-- DATALOG: QUERY EXAMPLES - CALLS AND CHAINS -->
<section>
  <h2>Query: "What does <code>repo</code> call &mdash; including chains?"</h2>
  <div class="two-col">
    <div>
      <pre style="font-size: 0.45em;"><code class="language-prolog">% Direct calls on a named receiver
call_on(RName, MName, Site) :-
    call(Site, Recv, MName), Recv != -1,
    name(Recv, RName).

% Resolve repo.findById().orElseThrow()
% back to "repo"
chain_root(Site, Recv) :-
    call(Site, Recv, _), Recv != -1,
    !is_call_site(Recv).
chain_root(Site, Base) :-
    call(Site, Recv, _), Recv != -1,
    chain_root(Recv, Base).

chained_call(RootName, MName) :-
    call(Site, _, MName),
    chain_root(Site, Root),
    name(Root, RootName).</code></pre>
    </div>
    <div>
      <p><strong>Actual Souffl&eacute; output:</strong></p>
      <pre style="font-size: 0.45em;"><code class="nohighlight">$ cat output/call_on.csv
repo    findById    55
repo    save        148
items   isEmpty     108

$ cat output/chained_call.csv
repo    findById       â† direct
repo    orElseThrow    â† chained!
repo    save
items   isEmpty</code></pre>
      <div class="card" style="margin-top: 10px;">
        <h3 class="accent-purple">Why chain resolution matters</h3>
        <p>Without it, <code>orElseThrow</code> is called on <em>some call result</em>. With <code>chain_root</code>: <strong>both calls trace to <code>repo</code></strong>.</p>
      </div>
    </div>
  </div>
</section>

<!-- DATALOG: RUNNING IT + COMPOSING QUERIES -->
<section>
  <h2>Running It &amp; Composing Queries</h2>
  <div class="two-col">
    <div>
      <pre><code class="language-python"># Emit facts
from query.treesitter_to_datalog import emit_datalog
from query.datalog_plugins import make_default_registry

plugin = make_default_registry().get(Language.JAVA)
parser = get_parser("java")
tree = parser.parse(source_bytes)
facts = emit_datalog(tree.root_node, source_bytes,
                     plugin=plugin)
facts.to_souffle_facts(Path("out/facts"),
                       plugin=plugin)</code></pre>
      <pre style="margin-top: 8px;"><code class="language-bash"># Evaluate all rules at once
souffle -F out/facts -D out/results \
    query/analysis.dl</code></pre>
    </div>
    <div class="card">
      <h3 class="accent">Composability</h3>
      <p style="font-size: 0.75em;">Derived rules build on each other:</p>
      <ul style="font-size: 0.7em;">
        <li><code>scope_parent</code> &rarr; <code>scope_chain</code> (transitive)</li>
        <li><code>scope_chain</code> + <code>declares</code> &rarr; <code>visible_from</code></li>
        <li><code>call</code> + <code>is_call_site</code> &rarr; <code>chain_root</code></li>
        <li><code>chain_root</code> + <code>name</code> &rarr; <code>chained_call</code></li>
      </ul>
      <p style="font-size: 0.75em; margin-top: 12px;">Want a new query? Add a rule that joins existing relations. No new Python code, no new tree walker.</p>
      <p style="font-size: 0.75em; margin-top: 8px;"><strong>6 language plugins</strong> (Java, Python, JS, TS, Go, Rust) supply bridge facts so every rule works across languages.</p>
    </div>
  </div>
</section>

<!-- DATALOG: TOWARD FORMAL REASONING -->
<section>
  <h2>Toward Formal Reasoning</h2>
  <h3>Why Datalog facts are a foundation, not a destination</h3>
  <div class="two-col">
    <div class="card">
      <h3 class="accent">What we have today</h3>
      <ul>
        <li><code>scope_chain</code>, <code>visible_from</code> &mdash; lexical scoping</li>
        <li><code>refers_to</code> &mdash; approximate use-def chains</li>
        <li><code>call</code>, <code>chain_root</code> &mdash; call graph + chains</li>
        <li><code>typed_decl</code> &mdash; type annotations</li>
        <li>CFG construction &mdash; 15 languages</li>
      </ul>
    </div>
    <div class="card">
      <h3 class="accent-green">What this enables</h3>
      <table style="font-size: 0.55em;">
        <tr><th>Technique</th><th>Built on</th></tr>
        <tr><td><strong>Points-to</strong></td><td><code>call</code> + <code>refers_to</code> + <code>instantiation</code></td></tr>
        <tr><td><strong>Taint tracking</strong></td><td>CFG + <code>call</code> + <code>refers_to</code></td></tr>
        <tr><td><strong>Dead code</strong></td><td><code>declares</code> + <code>refers_to</code></td></tr>
        <tr><td><strong>Security policy</strong></td><td>Signals + <code>scope_chain</code></td></tr>
        <tr><td><strong>SMT verification</strong></td><td>CFG + <code>typed_decl</code> + conditions</td></tr>
      </table>
    </div>
  </div>
  <p class="small" style="margin-top: 10px;">Datalog facts are <strong>interoperable</strong> &mdash; Doop, CodeQL, and Souffl&eacute; all consume relational facts. The ontology is the interchange format.</p>
</section>

<!-- ============================================================ -->
<!-- SECTION: DATALOG-BASED INTEGRATION DETECTION -->
<!-- ============================================================ -->
<section class="section-divider">
  <h2>Datalog-Based Integration Detection</h2>
  <h3>Replacing regex with structural AST queries</h3>
</section>

<!-- DATALOG INTEGRATION: THE PROBLEM -->
<section>
  <h2>Regex vs. Structural Matching</h2>
  <div class="two-col">
    <div class="card">
      <h3 class="accent-pink">Regex limitations</h3>
      <ul>
        <li>Can match <code>@GetMapping</code> but can't verify it's <strong>inside a <code>@RestController</code> class</strong></li>
        <li>Can match <code>KafkaTemplate</code> but can't distinguish field declarations from string literals</li>
        <li>No structural composition &mdash; each pattern is an island</li>
      </ul>
    </div>
    <div class="card">
      <h3 class="accent-green">Datalog approach</h3>
      <ul>
        <li>Queries join across <strong>AST structure</strong>: annotations, types, parent nodes, scopes</li>
        <li>Patterns are <strong>data</strong> (TSV bridge facts), not code</li>
        <li>Composite rules prove structural properties impossible with regex</li>
      </ul>
    </div>
  </div>
  <p class="small" style="margin-top: 15px;">PoC: Spring Java patterns &mdash; HTTP_REST, MESSAGING, DATABASE. Parallel path, does not modify the regex detector.</p>
</section>

<!-- DATALOG INTEGRATION: THREE RULES -->
<section>
  <h2>Three Detection Rules</h2>
  <p>A single output relation, <code>integration_signal</code>, fed by three rules:</p>
  <div class="three-col" style="margin-top: 10px;">
    <div class="card" style="padding: 14px;">
      <h3 class="accent">1. Annotations</h3>
      <pre style="font-size: 0.38em;"><code class="language-prolog">integration_signal(AnnId,
    IType, Dir, AnnName, Row) :-
  annotation_node(AnnId, AnnName),
  annotation_integration(
    AnnName, IType, Dir),
  position(AnnId, Row, _, _, _).</code></pre>
      <p class="small"><code>@GetMapping</code> &rarr; HTTP_REST/INWARD</p>
    </div>
    <div class="card" style="padding: 14px;">
      <h3 class="accent-green">2. Type References</h3>
      <pre style="font-size: 0.38em;"><code class="language-prolog">integration_signal(TypeNode,
    IType, Dir, TypeName, Row) :-
  node(TypeNode, "type_identifier"),
  name(TypeNode, TypeName),
  type_integration(
    TypeName, IType, Dir),
  position(TypeNode, Row, _, _, _).</code></pre>
      <p class="small"><code>KafkaTemplate</code> &rarr; MESSAGING/OUTWARD</p>
    </div>
    <div class="card" style="padding: 14px;">
      <h3 class="accent-amber">3. Instantiations</h3>
      <pre style="font-size: 0.38em;"><code class="language-prolog">integration_signal(SiteId,
    IType, Dir, TypeName, Row) :-
  instantiation(SiteId, TypeName),
  type_integration(
    TypeName, IType, Dir),
  position(SiteId, Row, _, _, _).</code></pre>
      <p class="small"><code>new JdbcTemplate()</code> &rarr; DATABASE/OUTWARD</p>
    </div>
  </div>
</section>

<!-- DATALOG INTEGRATION: BRIDGE FACTS -->
<section>
  <h2>Data-Driven Pattern Mapping</h2>
  <h3>Bridge facts separate patterns from rules</h3>
  <div class="two-col">
    <div>
      <pre style="font-size: 0.42em;"><code class="language-python">SPRING_BRIDGE_FACTS = FrameworkBridgeFacts(
  annotations=(
    AnnotationMapping("RestController",
      IntegrationType.HTTP_REST, SignalDirection.INWARD),
    AnnotationMapping("GetMapping",
      IntegrationType.HTTP_REST, SignalDirection.INWARD),
    AnnotationMapping("KafkaListener",
      IntegrationType.MESSAGING, SignalDirection.INWARD),
    # ... 12 more
  ),
  types=(
    TypeMapping("KafkaTemplate",
      IntegrationType.MESSAGING, SignalDirection.OUTWARD),
    TypeMapping("JdbcTemplate",
      IntegrationType.DATABASE, SignalDirection.OUTWARD),
    # ... 8 more
  ),
)</code></pre>
    </div>
    <div>
      <pre style="font-size: 0.42em;"><code class="nohighlight">% annotation_integration.facts
RestController  http_rest   inward
GetMapping      http_rest   inward
PostMapping     http_rest   inward
KafkaListener   messaging   inward
Transactional   database    ambiguous
% type_integration.facts
KafkaTemplate   messaging   outward
JdbcTemplate    database    outward
Neo4jRepository database    outward
RestTemplate    http_rest   outward</code></pre>
      <div class="card" style="margin-top: 10px;">
        <h3 class="accent">Adding a new pattern</h3>
        <p>Add a row to the dataclass. No Souffl&eacute; edits, no regex, no tree walker.</p>
      </div>
    </div>
  </div>
</section>

<!-- DATALOG INTEGRATION: COMPOSITE RULE -->
<section>
  <h2>Composite Rule: <code>controller_endpoint</code></h2>
  <h3>Structural composition impossible with regex</h3>
  <div class="two-col">
    <div>
      <pre style="font-size: 0.48em;"><code class="language-prolog">controller_endpoint(ClassAnnId, MethodAnnId,
    ClassName, MethodName, HttpVerb, Line) :-
  // Class has a controller annotation
  annotation_node(ClassAnnId, ClassAnnName),
  controller_annotation(ClassAnnName),
  ancestor(ClassAnnId, ClassNode),
  node(ClassNode, "class_declaration"),
  field(ClassNode, "name", ClassNameNode),
  name(ClassNameNode, ClassName),
  // Method inside the class has an HTTP annotation
  annotation_node(MethodAnnId, HttpVerb),
  http_method_annotation(HttpVerb),
  ancestor(MethodAnnId, MethodNode),
  node(MethodNode, "method_declaration"),
  ancestor(MethodNode, ClassNode),
  field(MethodNode, "name", MethodNameNode),
  name(MethodNameNode, MethodName),
  position(MethodAnnId, Line, _, _, _).</code></pre>
    </div>
    <div>
      <p><strong>Input:</strong></p>
      <pre style="font-size: 0.48em;"><code class="language-java">@RestController
public class UserController {
    @GetMapping("/users/{id}")
    public User getUser(@PathVariable String id) {
        return service.findById(id);
    }
    @PostMapping("/users")
    public User createUser(@RequestBody User u) {
        return service.save(u);
    }
}</code></pre>
      <p style="margin-top: 10px;"><strong>Output:</strong></p>
      <pre style="font-size: 0.48em;"><code class="nohighlight">% controller_endpoint.csv
...  UserController  getUser     GetMapping   3
...  UserController  createUser  PostMapping  8</code></pre>
      <p class="small" style="margin-top: 8px;">Proves <code>@GetMapping</code> is on a method <strong>inside</strong> a <code>@RestController</code> class &mdash; not just in the same file.</p>
    </div>
  </div>
</section>

<!-- DATALOG INTEGRATION: RUNNING IT -->
<section>
  <h2>Running the Pipeline</h2>
  <div class="two-col">
    <div>
      <pre style="font-size: 0.42em;"><code class="language-python">from query.datalog_integration_runner import (
    detect_integrations_datalog, SPRING_BRIDGE_FACTS)
from query.datalog_plugins import make_default_registry

plugin = make_default_registry().get(Language.JAVA)
tree = get_parser("java").parse(source_bytes)

signals = detect_integrations_datalog(
    tree.root_node, source_bytes,
    file_path="UserController.java",
    plugin=plugin,
    bridge=SPRING_BRIDGE_FACTS,
    work_dir=Path("/tmp/datalog"),
)</code></pre>
      <pre style="font-size: 0.42em; margin-top: 8px;"><code class="nohighlight">RestController     http_rest    inward
GetMapping         http_rest    inward
PathVariable       http_rest    inward
PostMapping        http_rest    inward
RequestBody        http_rest    inward</code></pre>
    </div>
    <div>
      <div class="card">
        <h3 class="accent">Under the hood</h3>
        <ol>
          <li><code>emit_datalog()</code> &rarr; 16-relation fact set</li>
          <li><code>to_souffle_facts()</code> + bridge TSVs</li>
          <li><code>souffle</code> evaluates <code>spring_integration.dl</code></li>
          <li>Parse <code>integration_signal.csv</code> &rarr; <code>IntegrationSignal</code></li>
        </ol>
      </div>
      <div class="card" style="margin-top: 10px;">
        <h3 class="accent-green">Same output type</h3>
        <p>Returns <code>list[IntegrationSignal]</code> &mdash; identical to the regex detector. <code>source="Spring/Datalog"</code> distinguishes origin.</p>
      </div>
    </div>
  </div>
</section>

<!-- ============================================================ -->
<!-- SECTION: DESIGN DECISIONS -->
<!-- ============================================================ -->
<section class="section-divider">
  <h2>Design Decisions</h2>
  <h3>Patterns that hold the system together</h3>
</section>

<!-- DESIGN PATTERNS -->
<section>
  <h2>Key Design Patterns</h2>
  <div class="three-col">
    <div class="card">
      <h3 class="accent">Protocol-Based DI</h3>
      <p>Neo4j, LSP bridge, LLM models, file reading &mdash; all accessed through <code>typing.Protocol</code>. No concrete imports hardcoded.</p>
      <pre><code class="language-python">class Neo4jDriver(Protocol):
    def execute(self, query, params): ...
    def close(self): ...</code></pre>
    </div>
    <div class="card">
      <h3 class="accent-green">Frozen Dataclasses</h3>
      <p>Every DTO is <code>@dataclass(frozen=True)</code>. The entire pipeline is <strong>immutable data transformations</strong>.</p>
      <pre><code class="language-python">@dataclass(frozen=True)
class IntegrationSignal:
    match: FileMatch
    integration_type: IntegrationType
    confidence: Confidence
    ...</code></pre>
    </div>
    <div class="card">
      <h3 class="accent-amber">Null Object Pattern</h3>
      <p>No <code>None</code> returns. Sentinel objects satisfy the same interface:</p>
      <pre><code class="language-python">NullSignalClassifier()
NullPipelineTimer()
EMPTY_FRAGMENT
_EMPTY_RANGE_MAP</code></pre>
    </div>
  </div>
</section>

<!-- TRAINING PIPELINE -->
<section>
  <h2>Training Data: Two Sources</h2>
  <div class="two-col">
    <div class="card">
      <h3 class="accent">Synthetic (Claude)</h3>
      <ul>
        <li>For each <code>(language, integration_type, label)</code> triple, prompt Claude to generate realistic code</li>
        <li>Validate against pattern registry</li>
        <li>Supports <strong>Batches API</strong> for 50% cost savings</li>
        <li>Checkpoint/resume support</li>
      </ul>
    </div>
    <div class="card">
      <h3 class="accent-green">Real Code (GitHub Harvest)</h3>
      <ul>
        <li>Use patterns themselves as <strong>GitHub code search queries</strong></li>
        <li>Pattern's <code>SignalDirection</code> provides the label automatically</li>
        <li><code>--not-definite</code> mode harvests false-positive examples</li>
        <li>No LLM needed for labelling</li>
      </ul>
    </div>
  </div>
  <p style="margin-top: 20px;">Both export stratified <strong>train/val/test JSONL</strong> splits for classifier training.</p>
</section>

<!-- ============================================================ -->
<!-- TECH STACK -->
<!-- ============================================================ -->
<section>
  <h2>Technology Stack</h2>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.7em;">
    <div class="card">
      <h3 class="accent">Core Analysis</h3>
      <ul>
        <li><strong>tree-sitter</strong> &mdash; syntax zone classification, CFG construction, AST walks, Datalog emission</li>
        <li><strong>Universal CTags</strong> &mdash; symbol extraction with line ranges</li>
        <li><strong>Regex</strong> &mdash; framework-aware pattern matching</li>
      </ul>
    </div>
    <div class="card">
      <h3 class="accent-green">ML / AI</h3>
      <ul>
        <li><strong>scikit-learn</strong> &mdash; TF-IDF + LR signal classifier (inference)</li>
        <li><strong>Claude API</strong> &mdash; synthetic training data generation</li>
        <li><strong>Ollama</strong> &mdash; local LLM concretisation (optional)</li>
      </ul>
    </div>
    <div class="card">
      <h3 class="accent-amber">Persistence &amp; Query</h3>
      <ul>
        <li><strong>Neo4j</strong> &mdash; graph database for analysis results</li>
        <li><strong>Souffl&eacute;</strong> &mdash; Datalog engine for structural queries</li>
      </ul>
    </div>
    <div class="card">
      <h3 class="accent-purple">Visualisation</h3>
      <ul>
        <li><strong>Graphviz</strong> &mdash; CFG and integration diagrams (DOT &rarr; SVG)</li>
        <li><strong>Pydantic</strong> &mdash; structured JSON reports</li>
      </ul>
    </div>
  </div>
</section>

<!-- ============================================================ -->
<!-- SUMMARY -->
<!-- ============================================================ -->
<section data-background-gradient="linear-gradient(135deg, #0f172a, #1e1b4b)">
  <h2>Summary</h2>
  <div style="max-width: 700px; margin: 0 auto; text-align: left;">
    <ul>
      <li><strong class="accent">16 languages</strong>, 90+ frameworks, 13 integration types</li>
      <li><strong class="accent-green">Six-stage pipeline</strong>: detect &rarr; extract &rarr; match &rarr; dedup &rarr; resolve &rarr; classify</li>
      <li><strong class="accent-amber">Six concretisation experiments</strong>: ML, embedding (generic + pattern), Ollama, Gemini Flash, and hybrid</li>
      <li><strong class="accent-purple">Language-independent CFG</strong> via 12-role schema &mdash; one algorithm, per-language JSON</li>
      <li><strong class="accent-pink">Datalog integration detection</strong>: structural AST queries replace regex with data-driven bridge facts</li>
      <li><strong>Declarative plugin system</strong>: add a language with JSON + a pattern file</li>
    </ul>
  </div>
  <pre style="margin-top: 15px;"><code class="language-bash">pip install codescry  # or: poetry install</code></pre>
</section>

<!-- END -->
<section data-background-gradient="linear-gradient(135deg, #0f172a, #1e1b4b)">
  <h1 style="background: linear-gradient(135deg, #38bdf8, #818cf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Thank You</h1>
  <p class="small" style="margin-top: 40px;">github.com/avishek-sen-gupta/codescry</p>
</section>

</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/dist/reveal.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/plugin/highlight/highlight.js"></script>
<script src="https://cdn.jsdelivr.net/npm/reveal.js@5.1.0/plugin/notes/notes.js"></script>
<script>
Reveal.initialize({
  hash: true,
  slideNumber: 'c/t',
  transition: 'slide',
  transitionSpeed: 'default',
  backgroundTransition: 'fade',
  center: false,
  plugins: [RevealHighlight, RevealNotes],
  width: 1280,
  height: 720,
});
</script>
</body>
</html>
